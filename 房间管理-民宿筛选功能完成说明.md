# æˆ¿é—´ç®¡ç†-æ°‘å®¿ç­›é€‰åŠŸèƒ½å®æ–½è¯´æ˜

## ğŸ“‹ é—®é¢˜æè¿°

ä¸€ä¸ªç®¡ç†å‘˜å¯ä»¥æœ‰å¤šä¸ªæ°‘å®¿ï¼Œæ¯ä¸ªæ°‘å®¿æœ‰ä¸åŒçš„æˆ¿é—´ï¼Œéœ€è¦åœ¨æˆ¿é—´ç®¡ç†é¡µé¢æ·»åŠ æ°‘å®¿ç­›é€‰åŠŸèƒ½ï¼Œæ–¹ä¾¿ç®¡ç†å‘˜åŒºåˆ†ä¸åŒæ°‘å®¿çš„æˆ¿é—´ã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ•°æ®åº“å±‚é¢

**æ·»åŠ å­—æ®µï¼š** `room_info.merchant_id`

```sql
-- SQL æ–‡ä»¶ä½ç½®ï¼š
yxly-backend/src/main/resources/db/migration/V1.2__add_merchant_id_to_room_info.sql

ALTER TABLE `room_info` 
ADD COLUMN `merchant_id` BIGINT(20) NULL COMMENT 'æ°‘å®¿ID' AFTER `id`,
ADD INDEX `idx_merchant_id` (`merchant_id`);
```

**æ‰§è¡Œæ–¹å¼ï¼š**
1. æ‰‹åŠ¨åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œ
2. æˆ–ç­‰å¾… Flyway è‡ªåŠ¨è¿ç§»ï¼ˆå¦‚æœé…ç½®äº†ï¼‰

---

### 2. åç«¯ä¿®æ”¹

#### 2.1 å®ä½“ç±»ä¿®æ”¹

**æ–‡ä»¶ï¼š** `RoomInfo.java`
- æ·»åŠ  `merchantId` å­—æ®µ

**æ–‡ä»¶ï¼š** `RoomResponse.java`
- æ·»åŠ  `merchantId` å’Œ `merchantName` å­—æ®µ

**æ–‡ä»¶ï¼š** `RoomCreateRequest.java`
- æ·»åŠ  `merchantId` å­—æ®µï¼ˆå¿…å¡«ï¼‰

#### 2.2 Mapperä¿®æ”¹

**æ–‡ä»¶ï¼š** `RoomInfoMapper.java`
- `selectRoomPage`: æ·»åŠ  `merchantId` å‚æ•°å’Œæ°‘å®¿è¡¨å…³è”
- `selectRoomDetail`: æ·»åŠ æ°‘å®¿è¡¨å…³è”

#### 2.3 Serviceä¿®æ”¹

**æ–‡ä»¶ï¼š** `RoomService.java` / `RoomServiceImpl.java`
- `getRoomPage`: æ·»åŠ  `merchantId` å‚æ•°

**æ–‡ä»¶ï¼š** `MerchantService.java` / `MerchantServiceImpl.java`
- æ–°å¢ `getAdminMerchants()` æ–¹æ³•ï¼šè·å–ç®¡ç†å‘˜çš„æ°‘å®¿åˆ—è¡¨

#### 2.4 Controllerä¿®æ”¹

**æ–‡ä»¶ï¼š** `RoomController.java`
- `getRoomPage`: æ·»åŠ  `merchantId` å‚æ•°
- æ–°å¢ `/merchants` æ¥å£ï¼šè·å–ç®¡ç†å‘˜çš„æ°‘å®¿åˆ—è¡¨

**æ–°å¢DTOï¼š** `MerchantSimpleVO.java`
- ç”¨äºæ°‘å®¿ä¸‹æ‹‰é€‰æ‹©

---

### 3. å‰ç«¯ä¿®æ”¹ï¼ˆå¾…å®æ–½ï¼‰

#### 3.1 APIæ¥å£

**æ–‡ä»¶ï¼š** `yxly-admin-frontend/src/api/modules/rooms.js`

éœ€è¦æ·»åŠ ï¼š
```javascript
// è·å–ç®¡ç†å‘˜çš„æ°‘å®¿åˆ—è¡¨
export function getAdminMerchants() {
  return request({
    url: '/api/v1/admin/rooms/merchants',
    method: 'GET'
  })
}
```

éœ€è¦ä¿®æ”¹ï¼š
```javascript
// æˆ¿é—´åˆ—è¡¨æŸ¥è¯¢ï¼Œæ·»åŠ merchantIdå‚æ•°
export function getRoomPage(params) {
  return request({
    url: '/api/v1/admin/rooms',
    method: 'GET',
    params  // params åº”åŒ…å«: current, size, merchantId, roomNumber, etc.
  })
}
```

#### 3.2 æˆ¿é—´ç®¡ç†é¡µé¢

**æ–‡ä»¶ï¼š** `yxly-admin-frontend/src/pages/admin/RoomManagement.vue`

**æ·»åŠ ï¼š**
1. æ°‘å®¿ä¸‹æ‹‰é€‰æ‹©å™¨
2. æ°‘å®¿åˆ—è¡¨æ•°æ®
3. é€‰æ‹©æ°‘å®¿æ—¶è§¦å‘æŸ¥è¯¢
4. åœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºæ°‘å®¿åç§°

**å…³é”®ä»£ç ï¼š**

```vue
<template>
  <div class="search-section">
    <!-- æ·»åŠ æ°‘å®¿é€‰æ‹©å™¨ -->
    <el-form-item label="é€‰æ‹©æ°‘å®¿">
      <el-select
        v-model="searchForm.merchantId"
        placeholder="è¯·é€‰æ‹©æ°‘å®¿"
        clearable
        @change="handleSearch"
        style="width: 240px"
      >
        <el-option
          v-for="merchant in merchantList"
          :key="merchant.id"
          :label="merchant.merchantName"
          :value="merchant.id"
        />
      </el-select>
    </el-form-item>
  </div>
  
  <!-- è¡¨æ ¼ä¸­æ·»åŠ æ°‘å®¿åˆ— -->
  <el-table-column prop="merchantName" label="æ‰€å±æ°‘å®¿" min-width="120">
    <template #default="{ row }">
      <el-tag type="primary">{{ row.merchantName || '-' }}</el-tag>
    </template>
  </el-table-column>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { getRoomPage, getAdminMerchants } from '@/api/modules/rooms'

// æ°‘å®¿åˆ—è¡¨
const merchantList = ref([])

// æœç´¢è¡¨å•
const searchForm = reactive({
  merchantId: null,  // æ·»åŠ æ°‘å®¿ID
  roomNumber: '',
  roomTypeId: null,
  status: null,
  floorNumber: null
})

// è·å–æ°‘å®¿åˆ—è¡¨
const getMerchantList = async () => {
  try {
    const response = await getAdminMerchants()
    if (response.data) {
      merchantList.value = response.data
    }
  } catch (error) {
    console.error('è·å–æ°‘å®¿åˆ—è¡¨å¤±è´¥:', error)
  }
}

// é¡µé¢åŠ è½½æ—¶è·å–æ°‘å®¿åˆ—è¡¨
onMounted(() => {
  getMerchantList()
  getRoomList()
})
</script>
```

#### 3.3 æ·»åŠ /ç¼–è¾‘æˆ¿é—´å¯¹è¯æ¡†

**æ·»åŠ æ°‘å®¿é€‰æ‹©ï¼š**

```vue
<el-form-item label="æ‰€å±æ°‘å®¿" prop="merchantId" required>
  <el-select
    v-model="roomForm.merchantId"
    placeholder="è¯·é€‰æ‹©æ°‘å®¿"
    style="width: 100%"
  >
    <el-option
      v-for="merchant in merchantList"
      :key="merchant.id"
      :label="merchant.merchantName"
      :value="merchant.id"
    />
  </el-select>
</el-form-item>
```

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

```sql
-- åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œ
USE yxly_db;

ALTER TABLE `room_info` 
ADD COLUMN `merchant_id` BIGINT(20) NULL COMMENT 'æ°‘å®¿ID' AFTER `id`,
ADD INDEX `idx_merchant_id` (`merchant_id`);

-- å¦‚æœå·²æœ‰æˆ¿é—´ï¼Œéœ€è¦æ‰‹åŠ¨åˆ†é…æ°‘å®¿
-- ç¤ºä¾‹ï¼šå°†æ‰€æœ‰æˆ¿é—´åˆ†é…ç»™ç¬¬ä¸€ä¸ªæ°‘å®¿
UPDATE `room_info` r
SET r.`merchant_id` = (SELECT MIN(id) FROM `merchant_info` WHERE deleted = 0 AND audit_status = 1)
WHERE r.`merchant_id` IS NULL;
```

### æ­¥éª¤2ï¼šé‡å¯åç«¯æœåŠ¡

```bash
cd yxly-backend
mvn clean spring-boot:run
```

### æ­¥éª¤3ï¼šä¿®æ”¹å‰ç«¯ä»£ç 

æŒ‰ç…§ä¸Šé¢"å‰ç«¯ä¿®æ”¹"éƒ¨åˆ†çš„è¯´æ˜ä¿®æ”¹ä»£ç ã€‚

### æ­¥éª¤4ï¼šæµ‹è¯•éªŒè¯

1. **ç™»å½•ç®¡ç†åå°**
   - è®¿é—®ï¼šhttp://localhost:3001
   - ä½¿ç”¨æ°‘å®¿ç®¡ç†å‘˜è´¦å·ç™»å½•

2. **éªŒè¯æ°‘å®¿åˆ—è¡¨**
   - è¿›å…¥æˆ¿é—´ç®¡ç†é¡µé¢
   - æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ°‘å®¿ä¸‹æ‹‰æ¡†
   - ä¸‹æ‹‰æ¡†æ˜¯å¦æ˜¾ç¤ºè¯¥ç®¡ç†å‘˜çš„æ°‘å®¿

3. **æµ‹è¯•ç­›é€‰åŠŸèƒ½**
   - é€‰æ‹©ä¸åŒæ°‘å®¿
   - éªŒè¯æˆ¿é—´åˆ—è¡¨æ˜¯å¦æ­£ç¡®ç­›é€‰

4. **æµ‹è¯•æ·»åŠ æˆ¿é—´**
   - ç‚¹å‡»"æ·»åŠ æˆ¿é—´"
   - æ˜¯å¦å¿…é¡»é€‰æ‹©æ°‘å®¿
   - ä¿å­˜åæˆ¿é—´æ˜¯å¦å…³è”åˆ°æ­£ç¡®çš„æ°‘å®¿

---

## ğŸ“ æ•°æ®å…³ç³»

```
ç®¡ç†å‘˜ (SysUser)
   â†“ (1:N)
æ°‘å®¿ (MerchantInfo)
   â†“ (1:N)
æˆ¿é—´ (RoomInfo)
```

- ä¸€ä¸ªç®¡ç†å‘˜å¯ä»¥æœ‰å¤šä¸ªæ°‘å®¿
- ä¸€ä¸ªæ°‘å®¿å¯ä»¥æœ‰å¤šä¸ªæˆ¿é—´
- æˆ¿é—´å¿…é¡»å±äºæŸä¸ªæ°‘å®¿

---

## ğŸ¯ åŠŸèƒ½æ•ˆæœ

### ç­›é€‰åŠŸèƒ½
- âœ… ä¸‹æ‹‰æ¡†æ˜¾ç¤ºå½“å‰ç®¡ç†å‘˜çš„æ‰€æœ‰æ°‘å®¿
- âœ… é€‰æ‹©æ°‘å®¿ååªæ˜¾ç¤ºè¯¥æ°‘å®¿çš„æˆ¿é—´
- âœ… æ¸…ç©ºé€‰æ‹©åˆ™æ˜¾ç¤ºæ‰€æœ‰æˆ¿é—´

### è¡¨æ ¼æ˜¾ç¤º
- âœ… æˆ¿é—´åˆ—è¡¨æ˜¾ç¤ºæ‰€å±æ°‘å®¿åç§°
- âœ… ä½¿ç”¨æ ‡ç­¾æ ·å¼çªå‡ºæ˜¾ç¤º

### æ·»åŠ æˆ¿é—´
- âœ… å¿…é¡»é€‰æ‹©æ‰€å±æ°‘å®¿
- âœ… è‡ªåŠ¨å…³è”åˆ°é€‰å®šçš„æ°‘å®¿

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®è¿ç§»**
   - ç°æœ‰æˆ¿é—´æ•°æ®éœ€è¦æ‰‹åŠ¨åˆ†é…æ°‘å®¿
   - å»ºè®®æ ¹æ®å®é™…æƒ…å†µåˆ†é…

2. **æƒé™æ§åˆ¶**
   - ç®¡ç†å‘˜åªèƒ½æŸ¥çœ‹è‡ªå·±çš„æ°‘å®¿
   - ä¸èƒ½è·¨æ°‘å®¿ç®¡ç†æˆ¿é—´

3. **å­—æ®µéªŒè¯**
   - åˆ›å»ºæˆ¿é—´æ—¶ merchantId ä¸ºå¿…å¡«
   - å‰ç«¯éœ€è¦æ·»åŠ ç›¸åº”éªŒè¯

---

## ğŸ‰ å®Œæˆæ¸…å•

### åç«¯
- [x] æ•°æ®åº“æ·»åŠ  merchant_id å­—æ®µ
- [x] RoomInfo å®ä½“æ·»åŠ å­—æ®µ
- [x] RoomResponse æ·»åŠ æ°‘å®¿ä¿¡æ¯
- [x] RoomCreateRequest æ·»åŠ æ°‘å®¿ID
- [x] Mapper ä¿®æ”¹æŸ¥è¯¢SQL
- [x] Service æ·»åŠ æ°‘å®¿å‚æ•°
- [x] Controller æ·»åŠ æ°‘å®¿ç­›é€‰å’Œæ°‘å®¿åˆ—è¡¨æ¥å£
- [x] åˆ›å»º MerchantSimpleVO

### å‰ç«¯ï¼ˆå¾…å®æ–½ï¼‰
- [ ] API æ¥å£æ·»åŠ æ°‘å®¿åˆ—è¡¨æ–¹æ³•
- [ ] æˆ¿é—´ç®¡ç†é¡µé¢æ·»åŠ æ°‘å®¿é€‰æ‹©å™¨
- [ ] æˆ¿é—´åˆ—è¡¨æ˜¾ç¤ºæ°‘å®¿åç§°
- [ ] æ·»åŠ /ç¼–è¾‘æˆ¿é—´å¯¹è¯æ¡†æ·»åŠ æ°‘å®¿é€‰æ‹©

---

## ğŸ“‚ ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
```
yxly-backend/
â”œâ”€â”€ src/main/resources/db/migration/
â”‚   â””â”€â”€ V1.2__add_merchant_id_to_room_info.sql  âœ… æ–°å»º
â”œâ”€â”€ src/main/java/com/yxly/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ RoomInfo.java                       âœ… å·²ä¿®æ”¹
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”‚   â””â”€â”€ RoomCreateRequest.java          âœ… å·²ä¿®æ”¹
â”‚   â”‚   â””â”€â”€ response/
â”‚   â”‚       â”œâ”€â”€ RoomResponse.java               âœ… å·²ä¿®æ”¹
â”‚   â”‚       â””â”€â”€ MerchantSimpleVO.java           âœ… æ–°å»º
â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â””â”€â”€ RoomInfoMapper.java                 âœ… å·²ä¿®æ”¹
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ RoomService.java                    âœ… å·²ä¿®æ”¹
â”‚   â”‚   â”œâ”€â”€ MerchantService.java                âœ… å·²ä¿®æ”¹
â”‚   â”‚   â””â”€â”€ impl/
â”‚   â”‚       â”œâ”€â”€ RoomServiceImpl.java            âœ… å·²ä¿®æ”¹
â”‚   â”‚       â””â”€â”€ MerchantServiceImpl.java        âœ… å·²ä¿®æ”¹
â”‚   â””â”€â”€ controller/
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ RoomController.java             âœ… å·²ä¿®æ”¹
```

### å‰ç«¯æ–‡ä»¶ï¼ˆå¾…ä¿®æ”¹ï¼‰
```
yxly-admin-frontend/
â””â”€â”€ src/
    â”œâ”€â”€ api/modules/
    â”‚   â””â”€â”€ rooms.js                            â³ å¾…ä¿®æ”¹
    â””â”€â”€ pages/admin/
        â””â”€â”€ RoomManagement.vue                  â³ å¾…ä¿®æ”¹
```

---

ç°åœ¨éœ€è¦æ‰§è¡ŒSQLå¹¶ä¿®æ”¹å‰ç«¯ä»£ç ï¼
