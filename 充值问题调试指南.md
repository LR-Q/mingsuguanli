# 充值用户名显示问题调试指南

## 当前状态
您已经退出并重新登录，但充值记录仍然显示"superadmin"。这说明后端服务可能没有重启，或者修改没有生效。

## 调试步骤

### 步骤1：重启后端服务

**重要**：必须重启后端服务才能应用代码修改！

```bash
# 停止当前运行的后端服务（如果在IDE中运行，直接停止）
# 或者按 Ctrl+C 停止

# 重新启动后端服务
cd e:\CursorProject\LRminsu\yxly-backend
mvn spring-boot:run
```

**等待后端完全启动**（看到"Started Application"日志）

### 步骤2：清除浏览器中的旧Token

**重要**：旧的token不包含userId，必须清除！

**方法1：退出登录（推荐）**
1. 在用户端点击退出登录
2. 关闭浏览器标签页
3. 重新打开用户端登录页面

**方法2：清除Cookies**
1. 按F12打开开发者工具
2. 找到Application/Storage -> Cookies
3. 删除`yxly_token`和`yxly_refresh_token`
4. 刷新页面

### 步骤3：重新登录

1. 访问用户端登录页面：http://localhost:3000/login
2. 使用用户LLL的账号密码登录
3. **查看浏览器开发者工具的Network标签**：
   - 找到`login`请求
   - 查看Response，确认返回了token

### 步骤4：进行一次测试充值

1. 登录后进入"我的钱包"
2. 点击"充值"按钮
3. 输入金额（例如：50）
4. 提交充值申请

### 步骤5：查看后端日志

后端日志应该显示如下信息：

```
=== 收到充值申请请求 ===
=== 开始获取当前用户ID ===
从请求中提取的JWT token: 存在
JWT token验证通过
从JWT token中提取的userId: 3
=== 从JWT token成功获取userId: 3 ===
从SecurityUtils获取的userId: 3
调用充值服务: userId=3, amount=50
=== 开始处理充值申请 ===
接收到的userId: 3
充值金额: 50
查询到的用户信息: id=3, username=LLL, realName=LLL
准备保存充值记录: userId=3, username=LLL
充值记录保存成功: recordId=15, userId=3, username=LLL
=== 充值申请处理完成 ===
```

### 步骤6：验证结果

1. 在超级管理员端访问充值管理页面
2. 查看最新的充值记录
3. **预期结果**：用户名应该显示"LLL"，不是"superadmin"

## 关键检查点

### 检查点1：JWT Token中是否包含userId

查看后端日志：
```
从JWT token中提取的userId: ???
```

- ✅ 如果显示具体的数字（如3）→ Token正确
- ❌ 如果显示null → Token没有生成userId，需要检查`AuthServiceImpl.java`

### 检查点2：查询到的用户信息

查看后端日志：
```
查询到的用户信息: id=???, username=???, realName=???
```

- ✅ 如果显示`id=3, username=LLL` → 查询正确
- ❌ 如果显示`id=1, username=superadmin` → userId获取错误

### 检查点3：保存的充值记录

查看后端日志：
```
充值记录保存成功: recordId=???, userId=???, username=???
```

- ✅ 如果显示`userId=3, username=LLL` → 保存正确
- ❌ 如果显示`userId=1, username=superadmin` → 有问题

## 常见问题

### Q1：后端日志显示"JWT token中的userId为null"

**原因**：后端服务没有重启，或者使用的是旧token

**解决**：
1. 确认后端服务已重启
2. 退出登录，清除Cookies
3. 重新登录获取新token

### Q2：后端日志显示"从数据库查询获取userId: 1"

**原因**：
- Token中没有userId，回退到数据库查询
- 查询时使用了错误的username

**解决**：
1. 查看日志中的"从SecurityContext获取的username"是什么
2. 如果不是"LLL"，说明SecurityContext被错误设置

### Q3：重启后端服务报错

**可能的错误**：
- 编译错误：检查代码语法
- 端口占用：停止其他后端进程

**解决**：
- 查看错误信息
- 确保`javax.servlet`包可用（Spring Boot 2.7.x应该自带）

## 如果问题仍然存在

请收集以下信息：

1. **后端完整日志**（从启动到充值完成）
2. **前端Network日志**（login和recharge/apply请求的完整信息）
3. **数据库中的记录**：
```sql
-- 查看最新的充值记录
SELECT * FROM recharge_record ORDER BY id DESC LIMIT 5;

-- 查看用户LLL的信息
SELECT * FROM sys_user WHERE username = 'LLL';

-- 查看用户superadmin的信息
SELECT * FROM sys_user WHERE username = 'superadmin';
```

有了这些信息，我们可以精确定位问题所在。

## 预期的正确流程

```
用户LLL登录
  ↓
生成JWT token {sub: "LLL", userId: 3}
  ↓
前端保存token到Cookies
  ↓
用户点击充值
  ↓
前端发送请求（带token）
  ↓
SecurityUtils.getCurrentUserId()
  ├─ 从token提取userId = 3 ✅
  ├─ 查询用户: id=3, username=LLL ✅
  └─ 保存充值记录: userId=3, username=LLL ✅
  ↓
超级管理员查看: 用户名=LLL ✅
```

## 立即执行

1. **停止当前后端服务**
2. **重新运行 `mvn spring-boot:run`**
3. **等待启动完成**
4. **退出用户端登录，清除Cookies**
5. **重新登录**
6. **充值测试**
7. **查看日志和结果**

如果按照这个流程操作，问题应该能够解决。如果还有问题，请提供后端日志给我查看。
