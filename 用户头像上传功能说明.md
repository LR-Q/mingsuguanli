# 用户头像上传功能说明

## 功能概述
已完善用户头像上传功能，使用 MinIO 对象存储，参考房间图片上传实现。

## 实现细节

### 后端实现

#### 1. UserController 新增接口

**上传头像接口**
```java
POST /api/v1/user/avatar
参数: MultipartFile file (表单文件)
返回: {
  url: "头像访问URL",
  filename: "文件名",
  originalFilename: "原始文件名"
}
```

**更新用户信息接口**
```java
PUT /api/v1/user/profile
参数: {
  realName: "真实姓名",
  email: "邮箱",
  phone: "手机号",
  avatar: "头像URL"
}
返回: 更新后的用户信息
```

#### 2. 文件存储路径
- MinIO 存储路径：`avatars/{用户ID}/{年月日}/{UUID}.{扩展名}`
- 示例：`avatars/1/20251024/a1b2c3d4.jpg`

#### 3. 验证规则
- **文件类型**：只允许图片文件 (image/*)
- **文件大小**：最大 2MB
- **支持格式**：JPG, PNG, JPEG 等

#### 4. 自动更新
- 上传成功后自动更新数据库中的 `avatar` 字段
- 自动更新用户的 `update_time` 字段

### 前端实现

#### 1. API 接口 (`user.js`)
```javascript
// 上传用户头像
export function uploadAvatar(formData)

// 更新用户信息
export function updateUserProfile(data)
```

#### 2. Profile.vue 组件更新

**头像上传流程**
1. 用户选择图片
2. 验证文件格式和大小
3. 上传到 MinIO（通过后端 API）
4. 获取图片 URL
5. 自动保存到数据库
6. 更新本地状态和 Store

**个人信息保存流程**
1. 验证表单数据
2. 调用更新接口
3. 更新 Store 中的用户信息
4. 备份新数据作为原始数据

## 使用说明

### 用户操作步骤
1. 进入个人中心 → 个人信息页面
2. 在"头像设置"区域点击"上传头像"按钮
3. 选择图片文件（支持 JPG、PNG，不超过 2MB）
4. 系统自动上传并保存
5. 头像立即更新显示

### 编辑个人信息步骤
1. 点击"编辑信息"按钮
2. 修改允许编辑的字段：
   - 真实姓名
   - 邮箱
   - 手机号
   - 性别
   - 生日
   - 个人简介
3. 点击"保存修改"按钮
4. 系统验证并保存信息

## 注意事项

### 用户名限制
- 用户名不可编辑（设计决策）
- 原因：
  - 用户名作为账户唯一标识
  - 保持数据一致性
  - 防止恶意行为

### 安全性
- 所有接口需要用户登录
- 文件类型严格验证
- 文件大小限制
- MinIO 存储安全隔离

### 性能优化
- 图片按用户 ID 分目录存储
- 支持 MinIO CDN 加速
- 前端显示本地预览
- 异步上传不阻塞 UI

## 数据库字段

### sys_user 表相关字段
- `avatar` VARCHAR(255) - 头像 URL
- `real_name` VARCHAR(50) - 真实姓名
- `email` VARCHAR(100) - 邮箱
- `phone` VARCHAR(11) - 手机号
- `update_time` DATETIME - 更新时间

## 错误处理

### 常见错误
1. **401 用户未登录** - 需要重新登录
2. **400 只能上传图片文件** - 检查文件格式
3. **400 图片大小不能超过2MB** - 压缩图片后重试
4. **500 上传失败** - MinIO 服务异常，联系管理员

### 调试日志
- 后端：查看 `UserController` 日志
- 前端：浏览器控制台查看错误信息
- MinIO：检查 MinIO 服务状态

## 测试建议

### 功能测试
1. ✅ 上传正常图片（JPG, PNG）
2. ✅ 上传超大图片（>2MB）
3. ✅ 上传非图片文件
4. ✅ 编辑并保存个人信息
5. ✅ 取消编辑恢复原数据
6. ✅ 检查头像在其他页面的显示

### 兼容性测试
- Chrome
- Firefox
- Edge
- Safari
- 移动端浏览器

## 相关文件

### 后端
- `UserController.java` - 用户控制器
- `SysUser.java` - 用户实体
- `MinioService.java` - MinIO 服务
- `SysUserMapper.java` - 用户 Mapper

### 前端
- `user.js` - 用户 API
- `Profile.vue` - 个人信息页面
- `auth.js` - Auth Store

## 后续优化建议

1. **图片裁剪**
   - 前端添加图片裁剪功能
   - 统一头像尺寸（如 200x200）

2. **图片压缩**
   - 前端自动压缩大图片
   - 后端添加压缩处理

3. **多格式支持**
   - 支持 WebP 格式
   - 自动转换格式优化存储

4. **历史头像管理**
   - 保存历史头像记录
   - 支持回退到历史版本

5. **缓存优化**
   - 添加 CDN 缓存
   - 浏览器缓存策略

## 完成时间
2025-10-24
