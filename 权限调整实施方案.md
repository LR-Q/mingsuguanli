# 权限调整实施方案

## 已完成的后端工作 ✅

### 1. 创建超级管理员控制器

#### RechargeManagementController
- **路径**: `/controller/superadmin/RechargeManagementController.java`
- **路由**: `/v1/super-admin/recharge`
- **功能**:
  - 查看所有商户的充值记录
  - 审核充值申请

#### WithdrawManagementController  
- **路径**: `/controller/superadmin/WithdrawManagementController.java`
- **路由**: `/v1/super-admin/withdraw`
- **功能**:
  - 查看所有商户的提现记录
  - 审核提现申请

### 2. 创建民宿主提现申请控制器

#### WithdrawApplyController
- **路径**: `/controller/merchant/WithdrawApplyController.java`
- **路由**: `/v1/merchant/withdraw`
- **功能**:
  - 查看自己的提现记录 (`/my-records`)
  - 申请提现 (`/apply`)
  - 取消提现申请 (`/cancel/{id}`)
  - 查看提现详情 (`/{id}`)

### 3. 扩展 WithdrawService
添加了以下方法：
- `getMyWithdrawRecords()` - 查询自己的提现记录
- `cancelWithdraw()` - 取消提现申请
- `getMyWithdrawRecordById()` - 查看自己的提现详情（带权限验证）

## 需要完成的前端工作

### 方案 A：移动文件并修改路由 (推荐)

#### 步骤 1: 移动充值管理页面

**操作**: 手动移动文件
```
从: src/pages/admin/RechargeManagement.vue
到: src/pages/super-admin/RechargeManagement.vue
```

**修改API路径**:
```javascript
// 原路径
const API_BASE = '/api/v1/admin/recharge'

// 新路径
const API_BASE = '/api/v1/super-admin/recharge'
```

#### 步骤 2: 移动提现管理页面

**操作**: 手动移动文件
```
从: src/pages/admin/WithdrawManagement.vue
到: src/pages/super-admin/WithdrawManagement.vue
```

**修改API路径**:
```javascript
// 原路径
const API_BASE = '/api/v1/admin/withdraw'

// 新路径
const API_BASE = '/api/v1/super-admin/withdraw'
```

#### 步骤 3: 创建民宿主的提现申请页面

**新建文件**: `src/pages/merchant/WithdrawApply.vue`

**功能包括**:
- 查看自己的提现记录
- 申请提现
- 取消待审核的提现申请

**API路径**: `/api/v1/merchant/withdraw`

#### 步骤 4: 创建/更新 API 接口文件

**文件**: `src/api/modules/superAdmin.js`

添加充值和提现接口：
```javascript
/**
 * 获取充值记录
 */
export const getRechargeRecords = (params) => {
  return request({
    url: '/api/v1/super-admin/recharge',
    method: 'get',
    params
  })
}

/**
 * 审核充值
 */
export const auditRecharge = (data) => {
  return request({
    url: '/api/v1/super-admin/recharge/audit',
    method: 'post',
    data
  })
}

/**
 * 获取提现记录
 */
export const getWithdrawRecords = (params) => {
  return request({
    url: '/api/v1/super-admin/withdraw',
    method: 'get',
    params
  })
}

/**
 * 审核提现
 */
export const auditWithdraw = (data) => {
  return request({
    url: '/api/v1/super-admin/withdraw/audit',
    method: 'post',
    data
  })
}
```

**新建文件**: `src/api/modules/merchantWithdraw.js`

```javascript
import request from '@/utils/request'

/**
 * 查询自己的提现记录
 */
export const getMyWithdrawRecords = (params) => {
  return request({
    url: '/api/v1/merchant/withdraw/my-records',
    method: 'get',
    params
  })
}

/**
 * 申请提现
 */
export const applyWithdraw = (data) => {
  return request({
    url: '/api/v1/merchant/withdraw/apply',
    method: 'post',
    data
  })
}

/**
 * 取消提现申请
 */
export const cancelWithdraw = (id) => {
  return request({
    url: `/api/v1/merchant/withdraw/cancel/${id}`,
    method: 'post'
  })
}

/**
 * 获取提现记录详情
 */
export const getWithdrawDetail = (id) => {
  return request({
    url: `/api/v1/merchant/withdraw/${id}`,
    method: 'get'
  })
}
```

#### 步骤 5: 更新路由配置

**文件**: `src/router/index.js` 或相关路由文件

**超级管理员路由**:
```javascript
{
  path: '/super-admin',
  component: Layout,
  meta: { requiresAuth: true, requiresSuperAdmin: true },
  children: [
    {
      path: 'merchant-audit',
      name: 'MerchantAudit',
      component: () => import('@/pages/super-admin/MerchantAudit.vue'),
      meta: { title: '商户审核管理' }
    },
    {
      path: 'recharge',
      name: 'SuperAdminRecharge',
      component: () => import('@/pages/super-admin/RechargeManagement.vue'),
      meta: { title: '充值管理' }
    },
    {
      path: 'withdraw',
      name: 'SuperAdminWithdraw',
      component: () => import('@/pages/super-admin/WithdrawManagement.vue'),
      meta: { title: '提现管理' }
    }
  ]
}
```

**民宿主路由**:
```javascript
{
  path: '/merchant',
  component: Layout,
  meta: { requiresAuth: true, requiresMerchant: true },
  children: [
    {
      path: 'withdraw-apply',
      name: 'WithdrawApply',
      component: () => import('@/pages/merchant/WithdrawApply.vue'),
      meta: { title: '提现申请' }
    }
  ]
}
```

#### 步骤 6: 更新菜单配置

**超级管理员菜单**:
```javascript
{
  title: '商户管理',
  icon: 'Shop',
  children: [
    {
      title: '商户审核',
      path: '/super-admin/merchant-audit'
    }
  ]
},
{
  title: '财务管理',
  icon: 'Money',
  children: [
    {
      title: '充值管理',
      path: '/super-admin/recharge'
    },
    {
      title: '提现管理',
      path: '/super-admin/withdraw'
    }
  ]
}
```

**民宿主菜单** (移除充值管理，保留提现申请):
```javascript
{
  title: '财务管理',
  icon: 'Money',
  children: [
    {
      title: '提现申请',
      path: '/merchant/withdraw-apply'
    }
  ]
}
```

### 方案 B：仅修改API路由 (简单快速)

如果不想移动文件，可以：
1. 保持前端文件位置不变
2. 只修改 API 请求路径
3. 通过后端权限控制访问

**优点**: 改动最小
**缺点**: 文件组织不清晰

## 权限控制总结

### 超级管理员 (role_id = 3 或 role_code = 'SUPER_ADMIN')
可以访问：
- ✅ 商户审核管理
- ✅ 商户账号管理（重置密码）
- ✅ 充值管理（查看所有、审核）
- ✅ 提现管理（查看所有、审核）
- ✅ 位置管理（查看所有、编辑所有）

### 民宿主 (role_id = 2 或 role_code = 'MERCHANT_ADMIN')
可以访问：
- ✅ 客户管理（仅自己的）
- ✅ 订单管理（仅自己的）
- ✅ 房间管理（仅自己的）
- ✅ 位置管理（查看所有、仅编辑自己的）
- ✅ 提现申请（申请提现、查看自己的记录、取消待审核申请）
- ❌ 充值管理（完全移除）
- ❌ 提现审核（改为提现申请）

## 测试检查清单

### 后端测试
- [ ] 超级管理员可以访问 `/v1/super-admin/recharge`
- [ ] 超级管理员可以访问 `/v1/super-admin/withdraw`
- [ ] 超级管理员可以审核充值和提现
- [ ] 民宿主可以访问 `/v1/merchant/withdraw/my-records`
- [ ] 民宿主只能看到自己的提现记录
- [ ] 民宿主可以申请提现
- [ ] 民宿主可以取消自己的待审核提现
- [ ] 民宿主无法访问 `/v1/admin/recharge` (旧路由)
- [ ] 民宿主无法访问 `/v1/admin/withdraw` (旧路由)

### 前端测试
- [ ] 超级管理员菜单显示"充值管理"和"提现管理"
- [ ] 超级管理员可以看到所有充值记录
- [ ] 超级管理员可以看到所有提现记录
- [ ] 超级管理员可以审核充值和提现
- [ ] 民宿主菜单显示"提现申请"
- [ ] 民宿主菜单不显示"充值管理"
- [ ] 民宿主可以申请提现
- [ ] 民宿主只能看到自己的提现记录
- [ ] 民宿主可以取消待审核的提现申请
- [ ] 民宿主无法访问超级管理员的充值/提现管理页面

## 数据库检查

确保以下字段存在：
```sql
-- withdraw_record 表
CREATE TABLE withdraw_record (
  id BIGINT PRIMARY KEY,
  user_id BIGINT NOT NULL COMMENT '用户ID',
  username VARCHAR(50) COMMENT '用户名',
  amount DECIMAL(10,2) NOT NULL COMMENT '提现金额',
  withdraw_method VARCHAR(50) COMMENT '提现方式',
  account_info VARCHAR(200) COMMENT '收款账户信息',
  status INT DEFAULT 0 COMMENT '状态(0:待审核 1:审核通过 2:审核拒绝)',
  apply_time DATETIME COMMENT '申请时间',
  audit_time DATETIME COMMENT '审核时间',
  auditor_id BIGINT COMMENT '审核人ID',
  auditor_name VARCHAR(50) COMMENT '审核人姓名',
  audit_remark VARCHAR(500) COMMENT '审核备注',
  user_remark VARCHAR(500) COMMENT '用户备注',
  deleted INT DEFAULT 0 COMMENT '是否删除',
  create_time DATETIME DEFAULT CURRENT_TIMESTAMP,
  update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

## 建议的实施顺序

1. ✅ 后端：创建超级管理员控制器（已完成）
2. ✅ 后端：创建民宿主提现申请控制器（已完成）
3. ✅ 后端：扩展 WithdrawService（已完成）
4. ⏳ 前端：创建 API 接口文件
5. ⏳ 前端：移动页面文件到正确目录
6. ⏳ 前端：创建民宿主提现申请页面
7. ⏳ 前端：更新路由配置
8. ⏳ 前端：更新菜单配置
9. ⏳ 测试：权限隔离验证
10. ⏳ 测试：功能完整性测试

## 快速开始

由于后端已完成，建议您现在：

1. **手动移动文件**：
   - 将 `RechargeManagement.vue` 移动到 `super-admin` 目录
   - 将 `WithdrawManagement.vue` 移动到 `super-admin` 目录

2. **让我为您创建**：
   - API 接口文件
   - 民宿主提现申请页面
   - 更新后的页面（修改API路径）

您希望我现在帮您创建哪些文件？
