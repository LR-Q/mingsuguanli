# 订单状态逻辑说明

## 订单状态定义

| 状态码 | 数据库值 | 触发方式 | 管理员端显示 | 用户端显示 |
|--------|---------|---------|-------------|-----------|
| 1 | PENDING | 用户下单 | 待确认 | 待确认 |
| 2 | CONFIRMED | 管理员确认 | 已确认 | 已确认 |
| 3 | CHECKED_IN | 管理员办理入住 | 已入住 | 已入住 |
| 4 | CHECKED_OUT | 管理员办理退房 | 已退房 | 已完成 |
| 5 | CANCELLED | **用户取消** | **被取消** | **已取消** |
| 6 | CANCELLED_BY_ADMIN | **管理员取消** | **已取消** | **被取消** |

## 核心逻辑

### 1. 取消订单逻辑

#### 用户取消（状态码5）
- **操作方**：用户在个人中心
- **状态值**：5 (CANCELLED)
- **管理员看到**：被取消 ❌（表示被用户取消）
- **用户看到**：已取消 ✓（表示我取消的）
- **自动退款**：是

#### 管理员取消（状态码6）
- **操作方**：管理员在订单管理
- **状态值**：6 (CANCELLED_BY_ADMIN)
- **管理员看到**：已取消 ✓（表示我取消的）
- **用户看到**：被取消 ❌（表示被管理员取消）
- **自动退款**：是

### 2. 确认订单逻辑

#### 管理员确认订单
- **操作方**：管理员在订单管理
- **触发条件**：订单状态为"待确认"(1)
- **结果状态**：已确认 (2)
- **双方显示**：都显示"已确认"
- **按钮位置**：待确认订单的操作列

## API接口

### 后端接口

```java
// 1. 管理员确认订单
POST /api/admin/bookings/{id}/confirm

// 2. 管理员取消订单（状态改为6）
POST /api/admin/bookings/{id}/cancel?reason=取消原因

// 3. 用户取消订单（状态改为5）
POST /api/user/bookings/{id}/cancel?reason=取消原因
```

### 前端API方法

```javascript
// 管理员确认订单
adminConfirmBooking(id)

// 管理员取消订单
adminCancelBooking(id, reason)

// 用户取消订单
cancelBooking(id, reason)
```

## 操作权限

### 待确认状态(1)的订单
- ✅ 管理员可以：确认订单 → 状态2
- ✅ 管理员可以：取消订单 → 状态6
- ✅ 用户可以：取消订单 → 状态5

### 已确认状态(2)的订单
- ✅ 管理员可以：办理入住 → 状态3
- ❌ 用户不能：取消订单（需要联系管理员）

### 已入住状态(3)的订单
- ✅ 管理员可以：办理退房 → 状态4

## 筛选功能

### 管理员端筛选
- 待确认
- 已确认
- 已入住
- 已退房
- 被取消（用户取消的）
- 已取消（我取消的）

### 用户端筛选
- 全部订单
- 待确认
- 已确认
- 已完成
- 已取消（我取消的）
- 被取消（管理员取消的）

## 业务流程

```
用户下单
  ↓
[待确认] 状态1
  ↓
  ├─→ 用户取消 → [已取消] 状态5 → 用户看到"已取消"，管理员看到"被取消"
  ├─→ 管理员取消 → [已取消] 状态6 → 管理员看到"已取消"，用户看到"被取消"
  └─→ 管理员确认 → [已确认] 状态2
        ↓
      [已入住] 状态3
        ↓
      [已退房] 状态4
```

## 退款机制

### 自动退款条件
- 订单状态为"待确认"(1)
- 支付状态为"已支付"(1)

### 退款流程
1. 验证订单状态和支付状态
2. 计算退款金额（已付金额）
3. 退款到用户余额
4. 创建退款交易记录
5. 更新订单支付状态为"已退款"(3)
6. 更新订单状态（5或6）

### 退款金额
- 全额退款：订单的 `paidAmount` 字段

## 数据库字段

### booking_order 表
- `booking_status`: 订单状态 (1-6)
- `payment_status`: 支付状态 (0-3)
- `cancel_reason`: 取消原因
- `cancel_time`: 取消时间

### sys_user 表
- `balance`: 用户余额（退款会自动增加）

### financial_record 表
- 自动创建退款交易记录
- `type`: 1（收入-退款）
- `category`: "REFUND"
- `amount`: 退款金额
