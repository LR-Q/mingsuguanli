# 位置权限隔离功能实现说明

## 问题描述
之前的位置管理系统存在以下问题：
1. 无法区分位置属于哪个民宿主（商户）
2. 任何管理员都能修改所有位置，无权限隔离
3. 在添加位置时，不知道是哪个管理员添加的

## 解决方案

### 1. 数据库层面
- **添加字段**: 为 `location_info` 表添加 `merchant_id` 字段，用于标识位置属于哪个商户
- **执行脚本**: `add_merchant_id_to_location.sql`

```sql
-- 添加 merchant_id 字段
ALTER TABLE location_info
ADD COLUMN merchant_id BIGINT DEFAULT NULL COMMENT '商户ID' AFTER id;

-- 添加索引
CREATE INDEX idx_merchant_id ON location_info(merchant_id);
```

### 2. 实体类修改
- **文件**: `LocationInfo.java`
- **修改**: 添加 `merchantId` 字段

### 3. Service 层修改
- **文件**: `LocationInfoService.java` 和 `LocationInfoServiceImpl.java`
- **修改内容**:
  - 所有方法增加 `merchantId` 和 `roleCode` 参数
  - **创建位置**: 自动关联当前登录用户的 `merchantId`
  - **查询位置**: 
    - 超级管理员可以查看所有位置
    - 普通民宿主只能查看自己的位置
  - **更新/删除位置**: 
    - 超级管理员可以操作所有位置
    - 普通民宿主只能操作自己的位置
    - 其他民宿主的位置会抛出 `FORBIDDEN` 异常

### 4. Controller 层修改
- **文件**: `LocationController.java`
- **修改内容**:
  - 添加 `getCurrentUser()` 方法获取当前登录用户
  - 添加 `getRoleCode()` 方法获取用户角色代码
  - 所有接口调用时传递 `merchantId` 和 `roleCode`

## 权限规则

### 超级管理员 (SUPER_ADMIN)
- ✅ 可以查看所有民宿主的位置
- ✅ 可以创建、更新、删除任何位置
- ✅ 可以启用/禁用任何位置

### 民宿主管理员 (HOMESTAY_ADMIN)
- ✅ 只能查看自己创建的位置
- ✅ 只能创建属于自己的位置
- ✅ 只能更新、删除自己的位置
- ✅ 只能启用/禁用自己的位置
- ❌ 无法操作其他民宿主的位置

### 用户端 (USER)
- ✅ 可以在地图上查看所有启用的位置（`getActiveLocationList()` 方法）
- ℹ️ 此功能保持不变，用户可以看到所有民宿位置

## 使用步骤

### 1. 执行数据库迁移
```bash
mysql -u root -p yxly_dev < add_merchant_id_to_location.sql
```

### 2. 重启后端服务
```bash
mvn spring-boot:run
```

### 3. 测试
- **民宿主A登录**: 创建位置后，只能看到和编辑自己的位置
- **民宿主B登录**: 看不到也无法编辑民宿主A的位置
- **超级管理员登录**: 可以看到所有位置并管理
- **普通用户**: 前端地图显示所有启用的位置

## 错误处理
当民宿主尝试操作其他人的位置时，会抛出以下异常：
- `DATA_NOT_FOUND`: 位置信息不存在
- `FORBIDDEN`: 无权访问/修改/删除此位置信息
- `PARAM_ERROR`: 商户ID不能为空

## 注意事项
1. 创建位置时必须已登录并有有效的 `merchantId`
2. `roleCode` 判断基于 `role_id`:
   - `role_id = 1` → `SUPER_ADMIN`
   - `role_id = 2` → `HOMESTAY_ADMIN`
   - 其他 → `USER`
3. 用户端的位置查询接口不受影响，仍然显示所有启用的位置
