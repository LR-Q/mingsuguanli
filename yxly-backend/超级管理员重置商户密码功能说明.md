# 超级管理员重置商户密码功能说明

## 功能概述

超级管理员可以为忘记密码的商户重置密码，帮助商户恢复账号访问。

## 实现方式

套用现有的用户自助重置密码功能的逻辑，但简化了验证流程：

**用户自助重置密码**（已有功能）：
- 用户需要提供：手机号 + 邮箱（双重验证）
- 只能重置自己的密码

**超级管理员重置商户密码**（新功能）：
- 超级管理员提供：商户ID + 新密码
- 可以重置任何商户的密码
- 无需商户验证（管理员权限）

## 接口信息

### 请求接口

```http
POST /v1/super-admin/merchants/reset-password
```

### 请求参数

```json
{
  "merchantId": 1,
  "newPassword": "merchant123"
}
```

### 参数说明

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| merchantId | Long | 是 | 商户ID |
| newPassword | String | 是 | 新密码（6-20位，包含字母和数字） |

### 响应示例

**成功：**
```json
{
  "code": 200,
  "message": "密码重置成功",
  "data": null
}
```

**失败：**
```json
{
  "code": 404,
  "message": "商户不存在",
  "data": null
}
```

## 验证逻辑

### 1. 商户验证
- 检查商户是否存在
- 检查商户是否已删除

### 2. 用户验证
- 查询商户关联的管理员账号
- 检查账号是否存在
- 检查账号是否已删除
- 检查账号是否被禁用

### 3. 密码验证
- 长度：6-20个字符
- 复杂度：至少包含一个字母和一个数字
- 支持特殊字符：@$!%*#?&

### 4. 密码加密
- 使用 BCrypt 加密
- 与现有密码加密方式一致

## 代码结构

### 1. DTO - AdminResetPasswordRequest
```java
@Data
@Schema(description = "超级管理员重置商户密码请求")
public class AdminResetPasswordRequest {
    @NotNull(message = "商户ID不能为空")
    private Long merchantId;
    
    @NotBlank(message = "新密码不能为空")
    @Size(min = 6, max = 20, message = "密码长度在6-20个字符")
    @Pattern(regexp = "^(?=.*[A-Za-z])(?=.*\\d)[A-Za-z\\d@$!%*#?&]{6,}$", 
             message = "密码至少包含一个字母和一个数字")
    private String newPassword;
}
```

### 2. Service 接口
```java
/**
 * 超级管理员重置商户密码
 * 
 * @param request 重置密码请求
 */
void resetMerchantPassword(AdminResetPasswordRequest request);
```

### 3. Service 实现
```java
@Override
@Transactional(rollbackFor = Exception.class)
public void resetMerchantPassword(AdminResetPasswordRequest request) {
    // 1. 查询商户信息
    MerchantInfo merchantInfo = merchantInfoMapper.selectById(request.getMerchantId());
    
    // 2. 查询管理员用户
    SysUser user = userMapper.selectById(merchantInfo.getAdminUserId());
    
    // 3. 验证用户状态
    if (user.getStatus() == 0) {
        throw new BusinessException(ResultCode.USER_DISABLED, "商户账号已被禁用");
    }
    
    // 4. 加密并更新密码
    String encodedPassword = passwordEncoder.encode(request.getNewPassword());
    user.setPassword(encodedPassword);
    userMapper.updateById(user);
}
```

### 4. Controller 接口
```java
@PostMapping("/reset-password")
@Operation(summary = "重置商户密码", description = "超级管理员重置商户管理员账号密码")
public Result<Void> resetMerchantPassword(@Valid @RequestBody AdminResetPasswordRequest request) {
    merchantService.resetMerchantPassword(request);
    return Result.success(null, "密码重置成功");
}
```

## 使用流程

### 1. 商户忘记密码
商户联系平台客服，说明忘记密码。

### 2. 超级管理员操作
1. 登录超级管理员账号
2. 进入商户审核管理页面
3. 找到需要重置密码的商户
4. 点击"重置密码"按钮
5. 输入新密码（建议：`merchant123`）
6. 确认重置

### 3. 通知商户
- 通过电话、邮件等方式告知商户新密码
- 建议商户登录后立即修改密码

## 安全考虑

### 1. 权限控制
- 只有超级管理员（role_id=3）可以访问此接口
- 通过 Spring Security 验证用户角色

### 2. 密码强度
- 强制要求密码包含字母和数字
- 建议默认密码：`merchant123`

### 3. 操作日志
- 记录谁重置了谁的密码
- 记录重置时间
- 便于审计追踪

```java
log.info("商户密码重置成功: merchantId={}, username={}, merchantName={}", 
        request.getMerchantId(), user.getUsername(), merchantInfo.getMerchantName());
```

### 4. 防止滥用
- 只能重置已审核通过的商户
- 无法重置已禁用的账号
- 事务回滚保证数据一致性

## 前端集成建议

### 1. 在商户列表添加操作按钮

```html
<el-button 
  size="small" 
  type="warning" 
  @click="handleResetPassword(merchant)"
>
  重置密码
</el-button>
```

### 2. 弹出密码输入对话框

```vue
<el-dialog title="重置商户密码" v-model="resetPasswordVisible">
  <el-form :model="resetForm">
    <el-form-item label="商户名称">
      <el-input v-model="currentMerchant.merchantName" disabled />
    </el-form-item>
    <el-form-item label="新密码" required>
      <el-input 
        v-model="resetForm.newPassword" 
        type="password"
        placeholder="请输入新密码（建议：merchant123）"
      />
      <div class="tip">密码要求：6-20位，包含字母和数字</div>
    </el-form-item>
  </el-form>
  <template #footer>
    <el-button @click="resetPasswordVisible = false">取消</el-button>
    <el-button type="primary" @click="confirmResetPassword">确认重置</el-button>
  </template>
</el-dialog>
```

### 3. 调用接口

```javascript
async function confirmResetPassword() {
  try {
    await axios.post('/v1/super-admin/merchants/reset-password', {
      merchantId: currentMerchant.id,
      newPassword: resetForm.newPassword
    })
    
    ElMessage.success('密码重置成功，请通知商户')
    resetPasswordVisible.value = false
    
    // 显示新密码提示
    ElMessageBox.alert(
      `新密码：${resetForm.newPassword}\n请及时通知商户并建议其登录后修改密码`,
      '重置成功',
      { type: 'success' }
    )
  } catch (error) {
    ElMessage.error(error.message || '密码重置失败')
  }
}
```

## 测试步骤

### 1. 准备测试数据
```sql
-- 查看商户列表
SELECT id, merchant_name, admin_user_id, audit_status 
FROM merchant_info 
WHERE deleted = 0;

-- 查看商户管理员账号
SELECT id, username, phone, email, status 
FROM sys_user 
WHERE id IN (SELECT admin_user_id FROM merchant_info WHERE deleted = 0);
```

### 2. 测试重置密码
```bash
# 使用 Postman 或 curl 测试
curl -X POST http://localhost:8080/v1/super-admin/merchants/reset-password \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_TOKEN" \
  -d '{
    "merchantId": 1,
    "newPassword": "merchant123"
  }'
```

### 3. 验证密码是否重置成功
- 使用新密码登录商户账号
- 检查是否能正常登录

### 4. 测试边界情况
- ❌ 商户ID不存在
- ❌ 商户已删除
- ❌ 商户账号已禁用
- ❌ 密码格式不正确（少于6位、没有字母、没有数字）

## 扩展功能建议

### 1. 批量重置
允许超级管理员批量重置多个商户的密码。

### 2. 密码模板
提供预设的密码模板：
- `merchant123`（默认）
- `welcome2024`
- 随机生成强密码

### 3. 短信/邮件通知
重置密码后自动发送短信或邮件通知商户。

### 4. 操作审计
在后台管理界面显示密码重置操作记录。

## 总结

✅ 后端接口已实现  
✅ 套用了现有的重置密码逻辑  
✅ 提供了完整的验证和错误处理  
✅ 记录了操作日志便于审计  
⏳ 需要前端添加UI和调用接口  

这个功能完全可以套用现有的用户重置密码逻辑，只是去掉了手机号和邮箱的验证步骤，改为超级管理员直接重置。
