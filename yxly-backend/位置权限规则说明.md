# 位置管理权限规则说明

## 角色定义（sys_role 表）

| role_id | role_code | role_name | 说明 |
|---------|-----------|-----------|------|
| 1 | HOMESTAY_ADMIN | 管理员(民宿主) | 民宿主管理员 |
| 2 | USER | 用户 | 普通用户 |
| 3 | SUPER_ADMIN | 超级管理员 | 平台超级管理员 |

## 权限规则

### 🔍 查看位置（共享权限）

**所有管理员都可以查看所有位置**

- ✅ 民宿主A 可以看到民宿主B创建的位置
- ✅ 民宿主B 可以看到民宿主A创建的位置
- ✅ 超级管理员 可以看到所有位置
- ℹ️ 目的：方便管理员之间参考和学习

### ✏️ 编辑位置（隔离权限）

**每个管理员只能编辑自己创建的位置**

#### 民宿主管理员（HOMESTAY_ADMIN）
- ✅ 可以创建位置（自动关联自己的 merchantId）
- ✅ 可以编辑自己创建的位置（merchantId 匹配）
- ❌ 无法编辑其他民宿主的位置
- ❌ 无法删除其他民宿主的位置
- ❌ 无法启用/禁用其他民宿主的位置

#### 超级管理员（SUPER_ADMIN）
- ✅ 可以创建任意位置
- ✅ 可以编辑所有位置
- ✅ 可以删除所有位置
- ✅ 可以启用/禁用所有位置

## 实现逻辑

### 查询接口（不过滤）
```java
// 分页查询位置列表
public IPage<LocationResponse> getLocationPage(Long current, Long size, Long merchantId, String roleCode) {
    // 不按 merchantId 过滤，返回所有位置
    wrapper.orderByDesc(LocationInfo::getUpdateTime);
    return locationInfoMapper.selectPage(page, wrapper);
}

// 查询位置详情
public LocationResponse getLocationById(Long id, Long merchantId, String roleCode) {
    // 不验证 merchantId，直接返回
    return location;
}
```

### 编辑接口（验证权限）
```java
// 更新位置
public void updateLocation(Long id, LocationUpdateRequest request, Long merchantId, String roleCode) {
    LocationInfo location = locationInfoMapper.selectById(id);
    
    // 如果不是超级管理员，验证 merchantId 是否匹配
    if (!"SUPER_ADMIN".equals(roleCode)) {
        if (!location.getMerchantId().equals(merchantId)) {
            throw new BusinessException(ResultCode.FORBIDDEN, "无权修改此位置信息");
        }
    }
    
    // 执行更新
    locationInfoMapper.updateById(location);
}
```

### 创建接口（自动关联）
```java
// 创建位置
public Long createLocation(LocationUpdateRequest request, Long merchantId) {
    LocationInfo location = new LocationInfo();
    BeanUtils.copyProperties(request, location);
    
    // 自动关联当前用户的 merchantId
    location.setMerchantId(merchantId);
    
    locationInfoMapper.insert(location);
    return location.getId();
}
```

## 测试场景

### 场景1: 民宿主A 登录
1. **查看位置列表** → 可以看到民宿主A和民宿主B的所有位置
2. **点击编辑位置A（自己创建的）** → ✅ 可以编辑
3. **点击编辑位置B（别人创建的）** → ❌ 提示"无权修改此位置信息"
4. **创建新位置** → ✅ merchant_id 自动设置为民宿主A的ID

### 场景2: 超级管理员登录
1. **查看位置列表** → 可以看到所有位置
2. **编辑任意位置** → ✅ 可以编辑
3. **删除任意位置** → ✅ 可以删除

## 前端处理建议

### 位置列表页面
```javascript
// 显示所有位置，但根据 merchantId 显示不同样式
positions.forEach(position => {
  if (position.merchantId === currentUser.merchantId) {
    // 自己的位置 - 显示编辑/删除按钮
    showEditButton(position)
  } else {
    // 别人的位置 - 只读显示，或隐藏编辑按钮
    showReadOnlyView(position)
  }
})
```

### 编辑按钮权限控制
```javascript
// 判断是否可以编辑
function canEdit(position) {
  // 超级管理员可以编辑所有
  if (currentUser.roleCode === 'SUPER_ADMIN') {
    return true
  }
  
  // 民宿主只能编辑自己的
  return position.merchantId === currentUser.merchantId
}
```

## 注意事项

1. **创建位置时自动关联 merchantId** - 后端会自动设置，前端不需要传
2. **前端应该隐藏编辑按钮** - 虽然后端会验证，但前端也应该根据权限控制UI
3. **超级管理员是 role_id=3** - 不是 role_id=1
4. **位置查询是共享的** - 不要在前端过滤，让所有管理员都能看到
