# 前端权限控制实现说明

## 修改概述

实现了位置管理的前端权限控制，使得：
- **查看权限**：所有管理员可以查看所有位置
- **编辑权限**：只有位置创建者和超级管理员可以编辑

## 修改内容

### 1. 后端修改

#### LocationResponse.java
添加 `merchantId` 字段，让前端能够判断位置归属：

```java
@Schema(description = "商户ID")
private Long merchantId;
```

### 2. 前端修改

#### LocationManagement.vue

**导入用户状态管理**
```javascript
import { useAuthStore } from '@/stores/modules/auth'

// 获取用户信息
const authStore = useAuthStore()
const currentUser = computed(() => authStore.userInfo)
```

**添加权限判断函数**
```javascript
// 权限判断：是否可以编辑某个位置
const canEdit = (location) => {
  if (!currentUser.value) return false
  
  // 超级管理员可以编辑所有位置
  if (currentUser.value.roleCode === 'SUPER_ADMIN') {
    return true
  }
  
  // 民宿主只能编辑自己创建的位置
  return location.merchantId === currentUser.value.merchantId
}
```

**添加只读状态**
```javascript
const isReadOnly = ref(false) // 是否只读模式（查看别人的位置）
```

**按钮权限控制**
```html
<!-- 查看按钮（所有人都可以查看） -->
<el-button size="small" @click.stop="handleEdit(location)" v-if="!canEdit(location)">
  查看
</el-button>

<!-- 编辑按钮（仅创建者和超级管理员可见） -->
<el-button size="small" type="primary" @click.stop="handleEdit(location)" v-if="canEdit(location)">
  编辑
</el-button>

<!-- 启用/禁用按钮（仅创建者和超级管理员可见） -->
<el-button 
  v-if="canEdit(location)"
  size="small" 
  :type="location.isActive === 1 ? 'warning' : 'success'"
  @click.stop="handleToggleStatus(location)"
>
  {{ location.isActive === 1 ? '禁用' : '启用' }}
</el-button>

<!-- 删除按钮（仅创建者和超级管理员可见） -->
<el-button 
  v-if="canEdit(location)"
  size="small" 
  type="danger" 
  @click.stop="handleDelete(location)"
>
  删除
</el-button>
```

**表单只读模式**
```javascript
// 编辑位置
const handleEdit = (row) => {
  resetForm()
  isEdit.value = true
  editId.value = row.id
  
  // 判断是否有编辑权限
  isReadOnly.value = !canEdit(row)
  
  // 填充表单数据...
  
  if (isReadOnly.value) {
    ElMessage.info('您只能查看此位置信息，无权编辑')
  } else {
    ElMessage.info('可以在右侧编辑位置信息')
  }
}
```

**表单输入框禁用**
```html
<!-- 所有输入框都添加 :disabled="isReadOnly" -->
<el-input
  v-model="formData.name"
  placeholder="请输入位置名称"
  :disabled="isReadOnly"
/>

<!-- 开关也添加 -->
<el-switch
  v-model="formData.isActive"
  :active-value="1"
  :inactive-value="0"
  active-text="启用"
  inactive-text="禁用"
  :disabled="isReadOnly"
/>
```

**提交按钮隐藏**
```html
<!-- 只在非只读模式下显示提交按钮 -->
<el-form-item v-if="!isReadOnly">
  <el-button
    type="primary"
    @click="handleSubmit"
    :loading="submitLoading"
    style="width: 100%;"
  >
    {{ isEdit ? '更新位置' : '保存位置' }}
  </el-button>
</el-form-item>
```

**标题显示**
```html
<h3>{{ isReadOnly ? '查看位置' : (isEdit ? '编辑位置' : '添加位置') }}</h3>
```

## 用户体验

### 民宿主 A（merchantId=1）登录

**位置列表：**
- 自己创建的位置显示：[编辑] [启用/禁用] [删除] 按钮
- 其他人创建的位置显示：[查看] 按钮

**点击 [编辑] 按钮：**
- 可以修改所有字段
- 可以提交保存

**点击 [查看] 按钮：**
- 所有字段都是禁用状态（灰色）
- 没有提交按钮
- 提示："您只能查看此位置信息，无权编辑"

### 超级管理员（roleCode=SUPER_ADMIN）登录

**位置列表：**
- 所有位置都显示：[编辑] [启用/禁用] [删除] 按钮

**点击 [编辑] 按钮：**
- 可以修改任何位置
- 可以提交保存

## 权限验证流程

### 前端验证（UI控制）
1. 隐藏/禁用用户无权操作的按钮和输入框
2. 提升用户体验，避免无效操作

### 后端验证（安全保障）
1. 验证请求者的 merchantId 和 roleCode
2. 检查是否有权限操作该位置
3. 抛出异常阻止非法操作

## 测试步骤

### 1. 重启服务
```bash
# 后端
mvn spring-boot:run

# 前端
npm run dev
```

### 2. 登录测试

#### XYY（merchant_id=2）登录
1. 可以看到所有位置（包括小灰灰的）
2. 小灰灰的位置只有 [查看] 按钮，无 [编辑] [删除] 按钮
3. 点击查看，表单所有字段禁用，无提交按钮
4. 创建新位置，merchant_id 自动设置为 2

#### 小灰灰（merchant_id=1）登录
1. 可以看到所有位置（包括 XYY 的）
2. XYY 的位置只有 [查看] 按钮，无 [编辑] [删除] 按钮
3. 点击查看，表单所有字段禁用，无提交按钮
4. 可以编辑自己的位置

#### 超级管理员（role_id=3）登录
1. 可以看到所有位置
2. 所有位置都有 [编辑] [启用/禁用] [删除] 按钮
3. 可以编辑任何位置

## 注意事项

1. **必须重新登录** - 确保 token 中包含 merchantId 和 roleCode
2. **前端是辅助验证** - 真正的安全由后端保障
3. **按钮隐藏不等于权限控制** - 即使前端绕过，后端也会拦截
4. **merchantId 必须返回** - LocationResponse 必须包含 merchantId 字段

## 预期结果

✅ XYY 可以看到但不能编辑小灰灰的位置  
✅ 小灰灰可以看到但不能编辑 XYY 的位置  
✅ 超级管理员可以编辑所有位置  
✅ 点击查看时，表单禁用且无提交按钮  
✅ 创建位置时，merchant_id 正确关联  
