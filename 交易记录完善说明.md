# 交易记录完善说明

## 功能概述

当管理员确认用户订单时，系统会自动创建一条"消费"类型的交易记录，记录用户订房的支出。

## 实现内容

### 1. 后端改动

#### 1.1 订单确认时自动创建交易记录
文件：`BookingOrderServiceImpl.java` - `adminConfirmBooking()` 方法

```java
// 创建消费交易记录
FinancialRecord consumptionRecord = new FinancialRecord();
consumptionRecord.setRecordNo(order.getOrderNo());      // 使用订单号
consumptionRecord.setType(2);                           // 2=支出
consumptionRecord.setCategory("CONSUMPTION");            // 消费类型
consumptionRecord.setAmount(order.getTotalAmount());     // 订单总金额
consumptionRecord.setRelatedOrderId(order.getId());      // 关联订单ID
consumptionRecord.setRemark("订房消费 - 订单号:" + order.getOrderNo());
consumptionRecord.setOperatorId(user.getId());
consumptionRecord.setOperatorName(user.getUsername());
consumptionRecord.setRecordTime(LocalDateTime.now());
```

#### 1.2 新增财务记录服务

**FinancialRecordService.java**
- `getUserFinancialRecords()` - 获取用户财务记录（分页+分类筛选）

**FinancialRecordServiceImpl.java**
- 实现按用户ID、分类查询财务记录
- 按时间倒序排序

**FinancialRecordController.java**
- `GET /api/user/financial-records/my` - 获取我的财务记录

#### 1.3 安全配置
文件：`SecurityConfig.java`

添加：`/user/financial-records/**` 到允许访问列表

### 2. 前端改动

#### 2.1 新增财务记录API
文件：`api/modules/financial.js`

```javascript
export function getMyFinancialRecords(params) {
  return request({
    url: '/api/user/financial-records/my',
    method: 'GET',
    params
  })
}
```

#### 2.2 钱包页面加载消费记录
文件：`pages/user/center/Wallet.vue`

- 导入 `getMyFinancialRecords` API
- 在 `loadRechargeRecords()` 中并行加载财务记录
- 将财务记录转换为交易记录格式并合并显示

## 交易记录类型

### category 字段（数据库）

| 值 | 说明 | 显示类型 |
|----|------|---------|
| CONSUMPTION | 消费（订房） | consume |
| REFUND | 退款 | refund |
| ROOM | 房费（预留） | consume |
| DEPOSIT | 押金（预留） | - |
| EXPENSE | 费用（预留） | - |

### type 字段（前端显示）

| 值 | 说明 | 颜色 | 金额符号 |
|----|------|------|---------|
| recharge | 充值 | success(绿) | + |
| consume | 消费 | warning(橙) | - |
| refund | 退款 | info(蓝) | + |
| withdraw | 提现 | danger(红) | - |

## 业务流程

```
用户下单（待确认）
    ↓
管理员确认订单
    ↓
    ├─ 更新订单状态：待确认(1) → 已确认(2)
    └─ 创建交易记录
       ├─ 交易单号：订单号（如 YX20251017...）
       ├─ 交易类型：支出(2)
       ├─ 分类：CONSUMPTION
       ├─ 金额：订单总金额
       ├─ 说明：订房消费 - 订单号:YX... | 房间:110
       └─ 状态：成功
```

## 数据示例

### 数据库记录（financial_record表）

```sql
INSERT INTO financial_record (
  record_no,
  type,
  category,
  amount,
  related_order_id,
  remark,
  operator_id,
  operator_name,
  record_time
) VALUES (
  'YX20251017163519977',           -- 订单号
  2,                                -- 支出
  'CONSUMPTION',                    -- 消费
  98.00,                            -- 金额
  1,                                -- 订单ID
  '订房消费 - 订单号:YX20251017163519977 | 房间:110',
  5,                                -- 用户ID
  'kk',                             -- 用户名
  '2025-10-17 17:30:00'            -- 记录时间
);
```

### 前端显示

| 交易单号 | 交易类型 | 金额 | 交易说明 | 状态 | 交易时间 |
|---------|---------|------|---------|------|---------|
| YX20251017... | 消费 | -¥98.00 | 订房消费 - 订单号:YX... | 成功 | 2025-10-17 17:30:00 |

## API接口

### 后端接口

#### 1. 获取财务记录
```
GET /api/user/financial-records/my?current=1&size=10&category=CONSUMPTION
```

**参数：**
- current: 当前页（可选，默认1）
- size: 每页大小（可选，默认10）
- category: 分类筛选（可选，如 CONSUMPTION、REFUND）

**响应：**
```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "id": 1,
        "recordNo": "YX20251017163519977",
        "type": 2,
        "category": "CONSUMPTION",
        "amount": 98.00,
        "relatedOrderId": 1,
        "remark": "订房消费 - 订单号:YX20251017163519977 | 房间:110",
        "operatorId": 5,
        "operatorName": "kk",
        "recordTime": "2025-10-17 17:30:00"
      }
    ],
    "total": 1,
    "size": 10,
    "current": 1
  }
}
```

### 前端API

```javascript
// 获取我的财务记录
getMyFinancialRecords({
  current: 1,
  size: 10,
  category: 'CONSUMPTION'  // 可选
})
```

## 测试步骤

### 1. 重启后端
```bash
cd e:\CursorProject\LRminsu\yxly-backend
mvn spring-boot:run
```

### 2. 测试流程

1. **用户下单**
   - 登录用户账号（如 kk）
   - 选择房间预订
   - 提交订单（状态：待确认）

2. **管理员确认**
   - 登录管理员账号（admin）
   - 进入"订单管理"
   - 找到待确认订单
   - 点击"确认订单"按钮
   - ✅ 订单状态变为"已确认"

3. **查看交易记录**
   - 切换到用户账号（kk）
   - 进入"个人中心" → "我的钱包"
   - 查看交易记录列表
   - ✅ 应该看到新增的"消费"记录
   - ✅ 交易单号为订单号
   - ✅ 金额为订单总金额（负数显示）
   - ✅ 说明为"订房消费 - 订单号:..."

4. **筛选查看**
   - 在交易类型下拉框选择"消费"
   - ✅ 只显示消费记录
   - 选择"全部"
   - ✅ 显示所有交易记录（充值+消费+提现+退款）

## 注意事项

1. **幂等性**：管理员多次确认同一订单只会创建一次交易记录（因为只有待确认订单才能确认）

2. **异常处理**：创建交易记录失败不会影响订单确认成功

3. **记录时间**：使用订单确认时的当前时间

4. **金额一致性**：交易记录金额等于订单总金额

5. **关联查询**：通过 `relatedOrderId` 可以追溯到原始订单

## 扩展功能（后续可添加）

- [ ] 在交易记录中增加房间名称显示
- [ ] 支持点击交易记录跳转到对应订单详情
- [ ] 导出交易记录为Excel
- [ ] 交易记录统计图表
- [ ] 按日期范围筛选（前端已有UI，需要后端支持）
