# æˆ¿é—´ç®¡ç†-æ°‘å®¿ä½ç½®ç­›é€‰åŠŸèƒ½è¯´æ˜ï¼ˆå·²ä¿®æ­£ï¼‰

## ğŸ¯ é—®é¢˜å‘ç°ä¸ä¿®æ­£

### âŒ åŸé”™è¯¯ç†è§£
æœ€åˆé”™è¯¯åœ°è®¤ä¸º `merchant_info` è¡¨å­˜å‚¨çš„æ˜¯æ°‘å®¿ä¿¡æ¯ï¼Œå¯¼è‡´è®¾è®¡äº†é”™è¯¯çš„æ•°æ®å…³è”ã€‚

### âœ… æ­£ç¡®çš„æ•°æ®ç»“æ„

```
SysUser (ç®¡ç†å‘˜è´¦å·)
  id = 29 (XHH)
    â†“ admin_user_id
    
merchant_info (å•†æˆ·èµ„è´¨è¡¨)
  id = 1, admin_user_id = 29  â† XHHçš„å•†æˆ·èµ„è´¨ï¼ˆä¸€ä¸ªç®¡ç†å‘˜ä¸€æ¡è®°å½•ï¼‰
    â†“ merchant_id
    
location_info (æ°‘å®¿ä½ç½®è¡¨)
  id = 1, merchant_id = 1, name = "å°é¥­ç°1å·"  â† ç¬¬ä¸€ä¸ªæ°‘å®¿ä½ç½®
  id = 2, merchant_id = 1, name = "å°é¥­ç°2å·"  â† ç¬¬äºŒä¸ªæ°‘å®¿ä½ç½®
    â†“ location_id
    
room_info (æˆ¿é—´è¡¨)
  room_id = 110, location_id = 1  â†’ å±äº"å°é¥­ç°1å·"
  room_id = 210, location_id = 2  â†’ å±äº"å°é¥­ç°2å·"
```

---

## ğŸ“Š æ•°æ®è¡¨è¯´æ˜

| è¡¨å | ä½œç”¨ | å…³é”®å­—æ®µ |
|------|------|---------|
| `sys_user` | ç®¡ç†å‘˜è´¦å· | id, username, role_id |
| `merchant_info` | å•†æˆ·èµ„è´¨ä¿¡æ¯ | id, admin_user_id |
| **`location_info`** | **æ°‘å®¿ä½ç½®ä¿¡æ¯** | **id, merchant_id, name** |
| **`room_info`** | **æˆ¿é—´ä¿¡æ¯** | **id, location_id, room_number** |

---

## âœ… åç«¯ä¿®æ”¹ï¼ˆå·²å®Œæˆï¼‰

### 1. æ•°æ®åº“è¿ç§»

**æ–‡ä»¶ï¼š** `V1.2__add_merchant_id_to_room_info.sql`

```sql
-- æ·»åŠ  location_id å­—æ®µï¼ˆæ­£ç¡®çš„å­—æ®µåï¼‰
ALTER TABLE `room_info` 
ADD COLUMN `location_id` BIGINT(20) NULL COMMENT 'æ°‘å®¿ä½ç½®IDï¼ˆå…³è”location_infoè¡¨ï¼‰' AFTER `id`,
ADD INDEX `idx_location_id` (`location_id`);
```

### 2. å®ä½“ç±»ä¿®æ”¹

| æ–‡ä»¶ | å­—æ®µä¿®æ”¹ |
|------|---------|
| `RoomInfo.java` | æ·»åŠ  `locationId` |
| `RoomResponse.java` | æ·»åŠ  `locationId` å’Œ `locationName` |
| `RoomCreateRequest.java` | æ·»åŠ  `locationId`ï¼ˆå¿…å¡«ï¼‰ |
| `LocationSimpleVO.java` | æ–°å»ºï¼Œç”¨äºä¸‹æ‹‰é€‰æ‹© |

### 3. Serviceå±‚ä¿®æ”¹

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|---------|
| `LocationInfoService.java` | æ·»åŠ  `getLocationsByMerchant(merchantId)` |
| `LocationInfoServiceImpl.java` | å®ç°è·å–å•†æˆ·çš„æ°‘å®¿ä½ç½®åˆ—è¡¨ |
| `MerchantService.java` | æ·»åŠ  `getMerchantByAdminUserId(adminUserId)` |
| `MerchantServiceImpl.java` | å®ç°æ ¹æ®ç®¡ç†å‘˜IDè·å–å•†æˆ·ä¿¡æ¯ |
| `RoomService.java` | å‚æ•°æ”¹ä¸º `locationId` |
| `RoomServiceImpl.java` | å‚æ•°æ”¹ä¸º `locationId` |

### 4. Mapperå±‚ä¿®æ”¹

**æ–‡ä»¶ï¼š** `RoomInfoMapper.java`

```java
// å…³è” location_info è¡¨
@Select("SELECT r.*, rt.type_name as room_type_name, l.name as location_name " +
        "FROM room_info r " +
        "LEFT JOIN room_type rt ON r.room_type_id = rt.id " +
        "LEFT JOIN location_info l ON r.location_id = l.id " +
        "WHERE r.deleted = 0 ...")
```

### 5. Controllerå±‚ä¿®æ”¹

**æ–‡ä»¶ï¼š** `RoomController.java`

```java
// æ–°æ¥å£ï¼šè·å–æ°‘å®¿ä½ç½®åˆ—è¡¨
@GetMapping("/locations")
public Result<List<LocationSimpleVO>> getAdminLocations() {
    Long currentUserId = SecurityUtils.getCurrentUserId();
    MerchantInfo merchantInfo = merchantService.getMerchantByAdminUserId(currentUserId);
    List<LocationSimpleVO> locations = locationInfoService.getLocationsByMerchant(merchantInfo.getId());
    return Result.success(locations, "æŸ¥è¯¢æˆåŠŸ");
}

// æˆ¿é—´åˆ—è¡¨æŸ¥è¯¢
@GetMapping
public Result<PageResult<RoomResponse>> getRoomPage(
    @RequestParam(required = false) Long locationId,  // æ”¹ä¸º locationId
    ...
)
```

---

## ğŸ”§ æ•°æ®åˆå§‹åŒ–

### æ­¥éª¤1ï¼šæ‰§è¡Œæ•°æ®åº“è¿ç§»

```sql
USE yxly_db;

ALTER TABLE `room_info` 
ADD COLUMN `location_id` BIGINT(20) NULL COMMENT 'æ°‘å®¿ä½ç½®IDï¼ˆå…³è”location_infoè¡¨ï¼‰' AFTER `id`,
ADD INDEX `idx_location_id` (`location_id`);
```

### æ­¥éª¤2ï¼šæŸ¥çœ‹ç°æœ‰æ•°æ®

```sql
-- æŸ¥çœ‹æ°‘å®¿ä½ç½®
SELECT id, merchant_id, name, address FROM location_info WHERE deleted = 0;

-- æŸ¥çœ‹æˆ¿é—´
SELECT id, location_id, room_number FROM room_info WHERE deleted = 0;
```

### æ­¥éª¤3ï¼šåˆ†é…æˆ¿é—´åˆ°æ°‘å®¿ä½ç½®

**åœºæ™¯ï¼šXHHæœ‰ä¸¤ä¸ªæ°‘å®¿ä½ç½®**

```sql
-- åˆ†é… 110, 120, 121 åˆ°"å°é¥­ç°1å·" (location_id=1)
UPDATE room_info 
SET location_id = 1 
WHERE room_number IN ('110', '120', '121');

-- åˆ†é… 210, 232, 330 åˆ°"å°é¥­ç°2å·" (location_id=2)
UPDATE room_info 
SET location_id = 2 
WHERE room_number IN ('210', '232', '330');
```

**å¦‚æœéœ€è¦åˆ›å»º"å°é¥­ç°2å·"ï¼š**

```sql
INSERT INTO location_info (merchant_id, name, address, province, city, district, ...) 
VALUES (1, 'å°é¥­ç°2å·', 'å¹¿ä¸œçœæ¢…å·å¸‚...', 'å¹¿ä¸œçœ', 'æ¢…å·å¸‚', 'æ¢…å¿åŒº', ...);
```

è¯¦ç»†SQLè§ï¼š**`åˆ†é…æˆ¿é—´åˆ°æ°‘å®¿ä½ç½®.sql`**

### æ­¥éª¤4ï¼šéªŒè¯

```sql
SELECT 
    r.room_number,
    r.location_id,
    l.name AS location_name,
    l.merchant_id,
    m.merchant_name
FROM room_info r
LEFT JOIN location_info l ON r.location_id = l.id
LEFT JOIN merchant_info m ON l.merchant_id = m.id
WHERE r.deleted = 0
ORDER BY r.room_number;
```

---

## ğŸš€ APIæ¥å£

### 1. è·å–æ°‘å®¿ä½ç½®åˆ—è¡¨

```http
GET /api/v1/admin/rooms/locations
```

**è¿”å›ï¼š**
```json
{
  "code": 200,
  "data": [
    {
      "id": 1,
      "name": "å°é¥­ç°1å·",
      "address": "å¹¿ä¸œçœæ¢…å·å¸‚...",
      "contactPhone": "19566782981",
      "isActive": 1
    },
    {
      "id": 2,
      "name": "å°é¥­ç°2å·",
      "address": "å¹¿ä¸œçœæ¢…å·å¸‚...",
      "contactPhone": "19772652172",
      "isActive": 1
    }
  ]
}
```

### 2. æŸ¥è¯¢æˆ¿é—´åˆ—è¡¨ï¼ˆæ”¯æŒæ°‘å®¿ç­›é€‰ï¼‰

```http
GET /api/v1/admin/rooms?locationId=1&current=1&size=10
```

**è¿”å›ï¼š**
```json
{
  "code": 200,
  "data": {
    "records": [
      {
        "id": 1,
        "locationId": 1,
        "locationName": "å°é¥­ç°1å·",
        "roomNumber": "110",
        ...
      }
    ],
    "total": 3
  }
}
```

### 3. åˆ›å»ºæˆ¿é—´

```http
POST /api/v1/admin/rooms

{
  "locationId": 1,  // å¿…å¡«
  "roomNumber": "140",
  "roomTypeId": 1,
  ...
}
```

---

## ğŸ“ å‰ç«¯ä¿®æ”¹ï¼ˆå¾…å®æ–½ï¼‰

### 1. APIæ¥å£

**æ–‡ä»¶ï¼š** `yxly-admin-frontend/src/api/modules/rooms.js`

```javascript
// è·å–æ°‘å®¿ä½ç½®åˆ—è¡¨
export function getAdminLocations() {
  return request({
    url: '/api/v1/admin/rooms/locations',
    method: 'GET'
  })
}

// æˆ¿é—´åˆ—è¡¨æŸ¥è¯¢ï¼ˆæ·»åŠ  locationId å‚æ•°ï¼‰
export function getRoomPage(params) {
  return request({
    url: '/api/v1/admin/rooms',
    method: 'GET',
    params  // { current, size, locationId, roomNumber, ... }
  })
}
```

### 2. æˆ¿é—´ç®¡ç†é¡µé¢

**æ–‡ä»¶ï¼š** `yxly-admin-frontend/src/pages/admin/RoomManagement.vue`

```vue
<template>
  <!-- æ·»åŠ æ°‘å®¿é€‰æ‹©å™¨ -->
  <el-form-item label="é€‰æ‹©æ°‘å®¿">
    <el-select
      v-model="searchForm.locationId"
      placeholder="è¯·é€‰æ‹©æ°‘å®¿ä½ç½®"
      clearable
      @change="handleSearch"
      style="width: 240px"
    >
      <el-option
        v-for="location in locationList"
        :key="location.id"
        :label="location.name"
        :value="location.id"
      />
    </el-select>
  </el-form-item>
  
  <!-- è¡¨æ ¼ä¸­æ˜¾ç¤ºæ°‘å®¿ä½ç½® -->
  <el-table-column prop="locationName" label="æ‰€å±æ°‘å®¿" min-width="120">
    <template #default="{ row }">
      <el-tag type="primary">{{ row.locationName || '-' }}</el-tag>
    </template>
  </el-table-column>
</template>

<script setup>
import { ref, reactive, onMounted } from 'vue'
import { getRoomPage, getAdminLocations } from '@/api/modules/rooms'

const locationList = ref([])

const searchForm = reactive({
  locationId: null,  // æ°‘å®¿ä½ç½®ID
  roomNumber: '',
  roomTypeId: null,
  status: null,
  floorNumber: null
})

// è·å–æ°‘å®¿ä½ç½®åˆ—è¡¨
const getLocationList = async () => {
  try {
    const response = await getAdminLocations()
    if (response.data) {
      locationList.value = response.data
    }
  } catch (error) {
    console.error('è·å–æ°‘å®¿ä½ç½®åˆ—è¡¨å¤±è´¥:', error)
  }
}

onMounted(() => {
  getLocationList()
  getRoomList()
})
</script>
```

### 3. æ·»åŠ /ç¼–è¾‘æˆ¿é—´å¯¹è¯æ¡†

```vue
<el-form-item label="æ‰€å±æ°‘å®¿" prop="locationId" required>
  <el-select
    v-model="roomForm.locationId"
    placeholder="è¯·é€‰æ‹©æ°‘å®¿ä½ç½®"
    style="width: 100%"
  >
    <el-option
      v-for="location in locationList"
      :key="location.id"
      :label="location.name"
      :value="location.id"
    />
  </el-select>
</el-form-item>
```

---

## ğŸ¯ åŠŸèƒ½æ•ˆæœ

### ç®¡ç†å‘˜ç™»å½•å

1. **é€‰æ‹©æ°‘å®¿ä½ç½®**
   - ä¸‹æ‹‰æ¡†æ˜¾ç¤ºè¯¥ç®¡ç†å‘˜çš„æ‰€æœ‰æ°‘å®¿ä½ç½®
   - ä¾‹å¦‚ï¼šXHHçœ‹åˆ°"å°é¥­ç°1å·"å’Œ"å°é¥­ç°2å·"

2. **ç­›é€‰æˆ¿é—´**
   - é€‰æ‹©"å°é¥­ç°1å·"ï¼šæ˜¾ç¤ºæˆ¿é—´ 110, 120, 121
   - é€‰æ‹©"å°é¥­ç°2å·"ï¼šæ˜¾ç¤ºæˆ¿é—´ 210, 232, 330
   - ä¸é€‰æ‹©ï¼šæ˜¾ç¤ºæ‰€æœ‰æˆ¿é—´

3. **æ·»åŠ æˆ¿é—´**
   - å¿…é¡»é€‰æ‹©æ‰€å±æ°‘å®¿ä½ç½®
   - æˆ¿é—´ä¼šå…³è”åˆ°é€‰å®šçš„æ°‘å®¿ä½ç½®

---

## âœ… å®Œæˆæ¸…å•

### åç«¯
- [x] SQLè¿ç§»ï¼šæ·»åŠ  location_id å­—æ®µ
- [x] RoomInfo å®ä½“ç±»ä¿®æ”¹
- [x] RoomResponse æ·»åŠ ä½ç½®ä¿¡æ¯
- [x] RoomCreateRequest æ·»åŠ ä½ç½®ID
- [x] åˆ›å»º LocationSimpleVO
- [x] LocationInfoService æ·»åŠ è·å–ä½ç½®åˆ—è¡¨æ–¹æ³•
- [x] MerchantService æ·»åŠ è·å–å•†æˆ·ä¿¡æ¯æ–¹æ³•
- [x] RoomService ä¿®æ”¹å‚æ•°
- [x] RoomMapper ä¿®æ”¹SQL
- [x] RoomController ä¿®æ”¹æ¥å£

### æ•°æ®åº“
- [ ] æ‰§è¡Œè¿ç§»SQL
- [ ] åˆ†é…ç°æœ‰æˆ¿é—´åˆ°æ°‘å®¿ä½ç½®

### å‰ç«¯
- [ ] APIæ¥å£æ·»åŠ ä½ç½®åˆ—è¡¨æ–¹æ³•
- [ ] æˆ¿é—´ç®¡ç†é¡µé¢æ·»åŠ ä½ç½®é€‰æ‹©å™¨
- [ ] æˆ¿é—´åˆ—è¡¨æ˜¾ç¤ºä½ç½®åç§°
- [ ] æ·»åŠ /ç¼–è¾‘æˆ¿é—´å¯¹è¯æ¡†æ·»åŠ ä½ç½®é€‰æ‹©

---

## ğŸ“‚ ç›¸å…³æ–‡ä»¶æ¸…å•

### åç«¯ï¼ˆå·²ä¿®æ”¹ï¼‰
```
yxly-backend/
â”œâ”€â”€ src/main/resources/db/migration/
â”‚   â””â”€â”€ V1.2__add_merchant_id_to_room_info.sql   âœ…
â”œâ”€â”€ src/main/java/com/yxly/
â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â””â”€â”€ RoomInfo.java                        âœ…
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”‚   â””â”€â”€ RoomCreateRequest.java           âœ…
â”‚   â”‚   â””â”€â”€ response/
â”‚   â”‚       â”œâ”€â”€ RoomResponse.java                âœ…
â”‚   â”‚       â””â”€â”€ LocationSimpleVO.java            âœ…
â”‚   â”œâ”€â”€ mapper/
â”‚   â”‚   â””â”€â”€ RoomInfoMapper.java                  âœ…
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ RoomService.java                     âœ…
â”‚   â”‚   â”œâ”€â”€ LocationInfoService.java             âœ…
â”‚   â”‚   â”œâ”€â”€ MerchantService.java                 âœ…
â”‚   â”‚   â””â”€â”€ impl/
â”‚   â”‚       â”œâ”€â”€ RoomServiceImpl.java             âœ…
â”‚   â”‚       â”œâ”€â”€ LocationInfoServiceImpl.java     âœ…
â”‚   â”‚       â””â”€â”€ MerchantServiceImpl.java         âœ…
â”‚   â””â”€â”€ controller/
â”‚       â””â”€â”€ admin/
â”‚           â””â”€â”€ RoomController.java              âœ…
```

### SQLè„šæœ¬
- `åˆ†é…æˆ¿é—´åˆ°æ°‘å®¿ä½ç½®.sql` - æ•°æ®åˆå§‹åŒ–è„šæœ¬

---

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒä¿®æ­£
- âœ… æ­£ç¡®è¯†åˆ«äº†æ•°æ®ç»“æ„ï¼šmerchant_info â‰  æ°‘å®¿ï¼Œlocation_info = æ°‘å®¿
- âœ… å­—æ®µå‘½åä¿®æ­£ï¼šmerchant_id â†’ location_id
- âœ… å…³è”è¡¨ä¿®æ­£ï¼šmerchant_info â†’ location_info
- âœ… APIè®¾è®¡ä¿®æ­£ï¼šè·å–æ°‘å®¿ä½ç½®åˆ—è¡¨ï¼ˆè€Œéå•†æˆ·åˆ—è¡¨ï¼‰

### æ•°æ®å…³ç³»
```
ä¸€ä¸ªç®¡ç†å‘˜ â†’ ä¸€ä¸ªå•†æˆ·èµ„è´¨ â†’ å¤šä¸ªæ°‘å®¿ä½ç½® â†’ å¤šä¸ªæˆ¿é—´
  (XHH)    â†’ (merchant_info) â†’ (å°é¥­ç°1å·,2å·) â†’ (110, 210...)
```

ç°åœ¨å¯ä»¥æ­£ç¡®åœ°æŒ‰æ°‘å®¿ä½ç½®ç­›é€‰æˆ¿é—´äº†ï¼ğŸš€
