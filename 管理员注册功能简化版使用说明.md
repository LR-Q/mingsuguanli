# 📝 民宿主管理员注册功能 - 简化版使用说明

## ✨ 简化后的注册流程

### **注册条件（极简）**
只需要填写5个核心信息：
1. ✅ **用户名** - 用于登录（3-50个字符）
2. ✅ **密码** - 需输入2次确认（至少6位，包含字母和数字）
3. ✅ **真实姓名** - 民宿主真实姓名
4. ✅ **手机号** - 联系电话
5. ✅ **身份证照片** - 正反面各一张

### **自动生成信息**
- 商户编码：系统自动生成（M+时间戳+随机数）
- 民宿名称：自动使用"姓名+的民宿"（如：张三的民宿）
- 联系人：自动使用真实姓名
- 联系电话：自动使用注册手机号

---

## 🚀 快速开始

### 1. 访问注册页面
```
http://localhost:5173/register
```
点击"我是民宿主，注册管理员账号"按钮

### 2. 填写注册信息示例
```
用户名: merchant001
密码: Test1234
确认密码: Test1234
真实姓名: 张三
手机号: 13800138001
身份证正面: [点击上传]
身份证反面: [点击上传]
```

### 3. 注册结果
- 系统自动创建账号（状态：禁用）
- 系统自动创建商户信息（商户名：张三的民宿）
- 提示"注册申请提交成功，请等待平台审核"

### 4. 审核通过（手动）
超级管理员在数据库中执行：
```sql
-- 审核通过
UPDATE sys_user SET status = 1, merchant_status = 1 WHERE username = 'merchant001';
UPDATE merchant_info SET audit_status = 1, audit_time = NOW() WHERE admin_user_id = (SELECT id FROM sys_user WHERE username = 'merchant001');
```

### 5. 登录使用
访问 `http://localhost:5173/login`，使用注册的账号登录

---

## 📊 简化对比

| 项目 | 简化前 | 简化后 |
|------|--------|--------|
| **必填字段** | 15个 | 5个 |
| **表单页面** | 复杂分段表单 | 简洁单页表单 |
| **民宿信息** | 需手动填写民宿名称、营业执照等 | 自动生成，后续可补充 |
| **地址信息** | 需填写省市区详细地址 | 可选，后续补充 |
| **银行账户** | 需填写开户银行、账号 | 可选，后续补充 |

---

## 🔧 技术实现

### 前端改动
- `MerchantRegister.vue` - 简化表单，只保留5个核心字段
- 集成身份证上传功能
- 移除复杂的分段表单

### 后端改动
- `MerchantRegisterRequest.java` - 简化DTO，只包含必要字段
- `MerchantServiceImpl.java` - 自动填充商户信息
- `UploadController.java` - 新增图片上传接口

### 数据库
- 数据库表结构保持不变
- 非必填字段允许为NULL或使用默认值

---

## 📸 图片上传说明（MinIO对象存储）

### 上传接口
```
POST /api/v1/upload/image
Content-Type: multipart/form-data
```

### 文件限制
- 文件类型：仅支持图片（jpg, png, jpeg等）
- 文件大小：最大5MB
- 存储方式：MinIO对象存储
- 存储路径：`idcards/yyyyMMdd/uuid.ext`

### 返回格式
```json
{
  "code": 200,
  "message": "上传成功",
  "data": {
    "url": "http://localhost:9000/yxly-homestay/idcards/20241021/abc123.jpg",
    "filename": "abc123.jpg",
    "originalFilename": "idcard.jpg",
    "objectName": "idcards/20241021/abc123.jpg"
  }
}
```

### MinIO部署（必须）
在测试前需要先部署MinIO服务，详见 **MinIO部署使用说明.md**

**快速启动MinIO（Docker）**:
```bash
docker run -d \
  --name minio \
  -p 9000:9000 \
  -p 9001:9001 \
  -e MINIO_ROOT_USER=minioadmin \
  -e MINIO_ROOT_PASSWORD=minioadmin \
  minio/minio server /data --console-address ":9001"
```

然后访问 http://localhost:9001 创建 `yxly-homestay` 存储桶

---

## 💡 注意事项

### 1. MinIO服务配置
- 必须先启动MinIO服务（端口9000）
- 创建存储桶 `yxly-homestay`
- 设置存储桶为公开访问

### 2. 配置文件
`application-dev.yml` 中MinIO配置：
```yaml
minio:
  endpoint: http://localhost:9000
  accessKey: minioadmin
  secretKey: minioadmin
  bucketName: yxly-homestay
  urlPrefix: http://localhost:9000/yxly-homestay/
```

### 3. 生产环境建议
- 修改MinIO默认密码
- 使用HTTPS访问
- 配置CDN加速
- 实现图片压缩和审核

---

## 🧪 测试步骤

### 0. 部署MinIO（必须）
```bash
# 使用Docker快速启动MinIO
docker run -d --name minio -p 9000:9000 -p 9001:9001 \
  -e MINIO_ROOT_USER=minioadmin -e MINIO_ROOT_PASSWORD=minioadmin \
  minio/minio server /data --console-address ":9001"

# 访问控制台创建存储桶
访问 http://localhost:9001
创建存储桶: yxly-homestay
设置为公开访问
```

### 1. 测试图片上传
```bash
curl -X POST http://localhost:8080/api/v1/upload/image \
  -F "file=@/path/to/idcard.jpg"
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "url": "http://localhost:9000/yxly-homestay/idcards/20241021/abc123.jpg"
  }
}
```

### 2. 测试注册
1. 访问注册页面
2. 填写用户名、密码、姓名、手机号
3. 上传身份证正反面
4. 提交注册

### 3. 检查数据
```sql
SELECT u.username, u.real_name, u.phone, u.status, u.merchant_status,
       m.merchant_name, m.merchant_code, m.contact_person
FROM sys_user u
LEFT JOIN merchant_info m ON u.merchant_id = m.id
WHERE u.username = 'merchant001';
```

应该看到：
- ✅ 用户账号已创建（status=0, merchant_status=0）
- ✅ 商户信息已创建（merchant_name="张三的民宿"）
- ✅ 身份证URL已保存

---

## 🎯 后续优化建议

### 功能增强
- [ ] 开发管理员审核页面（超级管理员使用）
- [ ] 实现在线身份证识别（OCR）
- [ ] 添加手机号验证码验证
- [ ] 实现邮件/短信审核通知

### 用户体验
- [ ] 添加注册进度条
- [ ] 实现图片裁剪预览
- [ ] 添加注册指引动画
- [ ] 优化移动端适配

### 安全加固
- [ ] 添加图片水印
- [ ] 实现防刷机制（限流）
- [ ] 身份证信息脱敏显示
- [ ] 添加注册日志审计

---

## 📞 常见问题

### Q1: 上传图片后看不到图片？
**A**: 检查MinIO存储桶是否设置为公开访问。在MinIO控制台设置 Bucket Policy 为 Public。

### Q2: 注册后无法登录？
**A**: 注册后账号默认禁用，需要超级管理员审核通过后才能登录。

### Q3: 想修改民宿名称怎么办？
**A**: 审核通过后，可以在管理后台的个人设置中修改民宿名称和其他信息。

### Q4: 身份证信息如何保护？
**A**: 建议：
- MinIO存储桶设置访问控制
- 使用临时访问令牌
- 仅超级管理员可查看
- 审核通过后可选择性删除

### Q5: MinIO连接失败？
**A**: 检查：
- MinIO服务是否启动
- 端口9000是否可访问
- application-dev.yml配置是否正确

---

## ✅ 简化版优势

1. **用户友好** - 填写项目减少70%，注册时间缩短到1分钟
2. **降低门槛** - 无需准备大量资料，后续可补充
3. **快速上线** - 先注册先审核，通过后再完善信息
4. **灵活扩展** - 保留完整数据库表结构，随时可扩展功能

---

**祝您使用愉快！** 🎉
