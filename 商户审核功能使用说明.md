# 商户审核功能使用说明

## 📋 功能概述

超级管理员可以审核民宿主管理员的注册申请，审核通过后用户角色将自动升级为 **HOMESTAY_ADMIN**（民宿主管理员）。

---

## 🎯 角色说明

系统支持三种角色：

| 角色代码 | 角色名称 | 权限说明 |
|---------|---------|---------|
| **SUPER_ADMIN** | 超级管理员 | 审核商户注册、管理整个平台 |
| **HOMESTAY_ADMIN** | 民宿主管理员 | 管理自己的民宿、房间、订单等 |
| **USER** | 普通用户 | 浏览房间、预订房间、管理个人信息 |

---

## 🚀 使用流程

### **步骤1：创建超级管理员账号**

执行SQL脚本创建超级管理员：

```bash
cd yxly-backend
mysql -u root -p < create_super_admin.sql
```

**默认超级管理员账号**：
- 用户名：`admin`
- 密码：`admin123`
- 角色：`SUPER_ADMIN`

---

### **步骤2：民宿主注册**

1. 访问民宿主注册页面：
   ```
   http://localhost:3000/merchant-register
   ```

2. 填写注册信息：
   - 用户名（必填）
   - 密码（必填）
   - 确认密码（必填）
   - 真实姓名（必填）
   - 手机号（必填）
   - 身份证正面照片（必填）
   - 身份证反面照片（必填）

3. 提交注册，系统会自动登录但用户状态为"待审核"

---

### **步骤3：超级管理员审核**

1. 使用超级管理员账号登录：
   ```
   用户名：admin
   密码：admin123
   ```

2. 登录后自动跳转到商户审核页面：
   ```
   http://localhost:3000/super-admin/merchants
   ```

3. 审核商户申请：
   - **查看身份证照片**：点击身份证图片可放大查看
   - **审核通过**：点击"通过"按钮，填写备注（可选），确认审核
   - **审核拒绝**：点击"拒绝"按钮，填写拒绝原因（必填），确认审核

---

### **步骤4：民宿主登录使用**

审核通过后，民宿主可以登录系统：

1. 访问登录页面：
   ```
   http://localhost:3000/login
   ```

2. 输入用户名和密码登录

3. 系统根据角色自动跳转：
   - **SUPER_ADMIN** → `/super-admin/merchants`（商户审核页）
   - **HOMESTAY_ADMIN** → `/merchant/dashboard`（商户后台）
   - **USER** → `/home`（用户首页）

---

## 📊 审核状态说明

| 状态值 | 状态名称 | 说明 |
|-------|---------|------|
| 0 | 待审核 | 商户刚提交注册，等待审核 |
| 1 | 已通过 | 审核通过，用户角色已升级 |
| 2 | 已拒绝 | 审核拒绝，用户需重新申请 |

---

## 🔧 技术实现

### **后端接口**

#### 1. 获取待审核商户列表
```
GET /api/v1/super-admin/merchants/pending
```

#### 2. 获取所有商户列表
```
GET /api/v1/super-admin/merchants/all?auditStatus=0
```

#### 3. 审核商户
```
POST /api/v1/super-admin/merchants/audit
Content-Type: application/json

{
  "merchantId": 1,
  "auditStatus": 1,
  "auditRemarks": "审核通过"
}
```

#### 4. 获取商户详情
```
GET /api/v1/super-admin/merchants/{merchantId}
```

---

### **前端路由**

```javascript
// 超级管理员路由
{
  path: '/super-admin/merchants',
  name: 'MerchantAudit',
  component: () => import('@/pages/super-admin/MerchantAudit.vue'),
  meta: {
    requiresAuth: true,
    requiresSuperAdmin: true
  }
}
```

---

### **登录跳转逻辑**

```javascript
// 登录成功后根据角色跳转
const roleCode = response.data.userInfo?.roleCode

if (roleCode === 'SUPER_ADMIN') {
  router.push('/super-admin/merchants')
} else if (roleCode === 'HOMESTAY_ADMIN') {
  router.push('/merchant/dashboard')
} else {
  router.push('/home')
}
```

---

## 🎯 测试步骤

### **1. 测试商户注册**

```bash
# 1. 确保MinIO运行
docker ps | findstr minio

# 2. 确保后端运行
cd yxly-backend
mvn spring-boot:run

# 3. 确保前端运行
cd yxly-frontend
npm run dev

# 4. 访问注册页面
http://localhost:3000/merchant-register
```

### **2. 测试超管审核**

```bash
# 1. 使用超管账号登录
http://localhost:3000/login
用户名：admin
密码：admin123

# 2. 自动跳转到商户审核页面
# 3. 查看待审核列表
# 4. 点击"通过"或"拒绝"进行审核
```

### **3. 测试民宿主登录**

```bash
# 1. 使用已审核通过的民宿主账号登录
# 2. 系统自动跳转到商户后台
http://localhost:3000/merchant/dashboard
```

---

## ⚠️ 注意事项

1. **MinIO配置**
   - 确保MinIO正常运行
   - 桶名：`txt`
   - 访问权限：公开（public）

2. **数据库配置**
   - 确保执行了 `create_merchant_tables.sql`
   - 确保创建了超级管理员账号

3. **角色权限**
   - 只有 `SUPER_ADMIN` 角色可以访问审核页面
   - 路由守卫会检查角色权限

4. **审核状态**
   - 已审核的商户无法重复审核
   - 审核拒绝后用户需要联系管理员重新申请

---

## 🐛 常见问题

### Q1: 登录后没有跳转到审核页面？
**A**: 检查用户角色是否为 `SUPER_ADMIN`，执行以下SQL：
```sql
SELECT u.username, r.role_code 
FROM sys_user u 
LEFT JOIN sys_role r ON u.role_id = r.id 
WHERE u.username = 'admin';
```

### Q2: 提示"无权访问"？
**A**: 确保当前登录用户的 `roleCode` 为 `SUPER_ADMIN`

### Q3: 商户列表为空？
**A**: 
1. 检查是否有商户注册
2. 查看后端日志是否有错误
3. 检查数据库中 `merchant_info` 表是否有数据

### Q4: 图片无法显示？
**A**: 
1. 检查MinIO是否运行
2. 检查桶权限是否为公开
3. 检查图片URL是否正确

---

## 📝 总结

✅ **已完成功能**：
- 后端商户审核接口（查询、审核）
- 前端超级管理员审核页面
- 登录角色跳转逻辑
- 路由权限控制

✅ **测试账号**：
- 超级管理员：`admin` / `admin123`

✅ **页面路由**：
- 商户注册：`/merchant-register`
- 超管审核：`/super-admin/merchants`
- 商户后台：`/merchant/dashboard`（待实现）

**开始使用商户审核功能吧！** 🎉
