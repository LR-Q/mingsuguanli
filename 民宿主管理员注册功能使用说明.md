# 民宿主管理员注册功能使用说明

## 📋 功能概述

本次更新为悦鑫乐怡民宿管理系统添加了**民宿主管理员注册功能**，支持多个民宿主注册并管理各自的民宿。该功能采用**多租户架构**设计，实现了数据隔离和权限管理。

---

## 🗂️ 文件清单

### 数据库文件
1. **`create_merchant_tables.sql`** - 独立SQL脚本，可直接在数据库中执行
2. **`src/main/resources/db/migration/V1.0.7__create_merchant_tables.sql`** - Flyway迁移脚本

### 后端文件
1. **实体类**
   - `com.yxly.entity.MerchantInfo.java` - 商户信息实体

2. **Mapper**
   - `com.yxly.mapper.MerchantInfoMapper.java` - 商户数据访问层

3. **Service**
   - `com.yxly.service.MerchantService.java` - 商户服务接口
   - `com.yxly.service.impl.MerchantServiceImpl.java` - 商户服务实现

4. **Controller**
   - `com.yxly.controller.merchant.MerchantController.java` - 商户控制器

5. **DTO**
   - `com.yxly.dto.request.MerchantRegisterRequest.java` - 管理员注册请求DTO

### 前端文件
1. **页面组件**
   - `src/pages/auth/MerchantRegister.vue` - 民宿主管理员注册页面
   - `src/pages/auth/Register.vue` - 已修改，添加入口按钮

2. **API模块**
   - `src/api/modules/merchant.js` - 商户相关API接口

3. **路由配置**
   - `src/router/index.js` - 已添加 `/merchant-register` 路由

---

## 🚀 部署步骤

### 第一步：执行数据库脚本

#### 方式一：使用独立SQL脚本
```sql
-- 在MySQL客户端中执行
USE yxly_dev;
SOURCE /path/to/create_merchant_tables.sql;
```

#### 方式二：使用Flyway自动迁移
重启后端应用，Flyway会自动执行 `V1.0.7__create_merchant_tables.sql`

### 第二步：验证数据库表

执行以下SQL检查表是否创建成功：
```sql
-- 检查商户表
SHOW TABLES LIKE 'merchant%';

-- 检查sys_user表新增字段
DESC sys_user;

-- 检查角色数据
SELECT * FROM sys_role WHERE role_code IN ('SUPER_ADMIN', 'HOMESTAY_ADMIN', 'USER');
```

### 第三步：重启后端服务

确保后端应用正常启动，没有报错信息。

### 第四步：重启前端服务

```bash
cd yxly-frontend
npm run dev
```

---

## 📊 数据库表结构说明

### 1. merchant_info（商户信息表）

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT | 商户ID（主键） |
| admin_user_id | BIGINT | 管理员用户ID |
| merchant_name | VARCHAR(100) | 民宿名称 |
| merchant_code | VARCHAR(50) | 商户编码（唯一） |
| business_license | VARCHAR(200) | 营业执照号 |
| contact_person | VARCHAR(50) | 联系人 |
| contact_phone | VARCHAR(20) | 联系电话 |
| contact_email | VARCHAR(100) | 联系邮箱 |
| province/city/district | VARCHAR(50) | 地区信息 |
| address | VARCHAR(200) | 详细地址 |
| id_card_front/back | VARCHAR(200) | 身份证照片URL |
| business_license_img | VARCHAR(200) | 营业执照图片URL |
| property_proof | VARCHAR(500) | 房产证明（JSON） |
| bank_name/account | VARCHAR | 银行账户信息 |
| audit_status | INT | 审核状态（0待审核 1已通过 2已拒绝） |
| settlement_rate | DECIMAL(5,2) | 结算比例 |
| status | INT | 状态（0禁用 1启用） |

### 2. sys_user表扩展字段

| 新增字段 | 类型 | 说明 |
|---------|------|------|
| merchant_id | BIGINT | 商户ID（关联merchant_info） |
| merchant_status | INT | 商户状态（0待审核 1已认证 2已拒绝） |
| apply_time | DATETIME | 申请时间 |

### 3. sys_role表数据

系统预置三个角色：
- **SUPER_ADMIN** - 超级管理员（平台运营）
- **HOMESTAY_ADMIN** - 民宿主管理员（管理自己的民宿）
- **USER** - 普通用户（预订客户）

### 4. room_info和booking_order表扩展

| 新增字段 | 类型 | 说明 |
|---------|------|------|
| merchant_id | BIGINT | 商户ID（实现数据隔离） |

---

## 🌐 访问路径

### 前端页面
- **普通用户注册**: `http://localhost:5173/register`
- **民宿主管理员注册**: `http://localhost:5173/merchant-register`
- **登录页面**: `http://localhost:5173/login`

### 后端API
- **管理员注册**: `POST /api/v1/merchant/register`
- **检查民宿名称**: `GET /api/v1/merchant/check-merchant-name?merchantName={name}`

---

## 👨‍💻 使用流程

### 民宿主注册流程

1. **访问注册页面**
   - 用户在普通注册页面点击"我是民宿主，注册管理员账号"按钮
   - 或直接访问 `/merchant-register`

2. **填写注册信息**
   - **账号信息**：用户名、密码、确认密码
   - **个人信息**：真实姓名、手机号、邮箱
   - **民宿信息**：民宿名称、营业执照号、联系人、联系电话
   - **地址信息**：省市区、详细地址
   - **资质证明**：可选，后续补充

3. **提交注册申请**
   - 系统创建用户账号（状态：禁用）
   - 创建商户信息（审核状态：待审核）
   - 分配"民宿主管理员"角色

4. **等待审核**
   - 超级管理员审核资质
   - 审核通过后，用户状态变为启用
   - 民宿主可以登录使用系统

### 超级管理员审核流程

> 注意：目前需要手动在数据库中审核，后续可开发管理后台

```sql
-- 审核通过
UPDATE sys_user SET status = 1, merchant_status = 1 WHERE id = {用户ID};
UPDATE merchant_info SET audit_status = 1, audit_time = NOW(), auditor_id = 1 WHERE admin_user_id = {用户ID};

-- 审核拒绝
UPDATE sys_user SET merchant_status = 2 WHERE id = {用户ID};
UPDATE merchant_info SET audit_status = 2, audit_remarks = '拒绝原因' WHERE admin_user_id = {用户ID};
```

---

## 🔑 权限说明

### 角色权限对比

| 功能 | 超级管理员 | 民宿主管理员 | 普通用户 |
|------|-----------|-------------|---------|
| 查看所有民宿数据 | ✅ | ❌ | ❌ |
| 管理自己的房源 | ✅ | ✅ | ❌ |
| 管理自己的订单 | ✅ | ✅ | ❌ |
| 审核民宿主申请 | ✅ | ❌ | ❌ |
| 预订房间 | ✅ | ✅ | ✅ |
| 查看全局统计 | ✅ | ❌ | ❌ |
| 管理系统配置 | ✅ | ❌ | ❌ |

### 数据隔离规则

民宿主管理员只能查看和管理 `merchant_id = 自己的商户ID` 的数据：
```sql
-- 查询房源时自动过滤
WHERE merchant_id = #{currentMerchantId}

-- 查询订单时自动过滤
WHERE merchant_id = #{currentMerchantId}
```

---

## 📝 注意事项

### 1. 必填信息
以下字段为必填项：
- 用户名、密码
- 真实姓名、手机号
- 民宿名称
- 联系人、联系电话

### 2. 资质上传
- 身份证、营业执照等资质证明可选
- 建议在注册后通过个人中心上传
- 需要开发文件上传接口（待实现）

### 3. 审核机制
- 注册后账号默认禁用，需要审核
- 审核通过后才能登录
- 建议开发管理后台审核功能

### 4. 数据迁移
如果系统已有数据，需要：
- 为现有房源分配 `merchant_id`
- 为现有订单分配 `merchant_id`
- 为现有用户设置角色

### 5. 后续开发建议
- [ ] 开发商户审核管理页面（超级管理员使用）
- [ ] 开发资质证明上传功能
- [ ] 实现数据权限自动过滤（MyBatis拦截器）
- [ ] 开发员工账号管理功能
- [ ] 实现收益结算功能

---

## 🧪 测试步骤

### 1. 测试民宿主注册

```bash
# 访问注册页面
http://localhost:5173/merchant-register

# 填写测试数据
用户名: merchant001
密码: Test1234
真实姓名: 张三
手机号: 13800138001
民宿名称: 张三的民宿
```

### 2. 检查数据库

```sql
-- 查看新注册的用户
SELECT * FROM sys_user WHERE username = 'merchant001';

-- 查看商户信息
SELECT * FROM merchant_info WHERE admin_user_id = (
    SELECT id FROM sys_user WHERE username = 'merchant001'
);
```

### 3. 手动审核通过

```sql
-- 获取用户ID
SET @user_id = (SELECT id FROM sys_user WHERE username = 'merchant001');

-- 审核通过
UPDATE sys_user SET status = 1, merchant_status = 1 WHERE id = @user_id;
UPDATE merchant_info SET audit_status = 1, audit_time = NOW() WHERE admin_user_id = @user_id;
```

### 4. 测试登录

访问登录页面，使用注册的账号登录，检查是否能正常进入管理后台。

---

## 🆘 常见问题

### Q1: 注册后无法登录？
**A**: 检查用户的 `status` 和 `merchant_status` 字段，确保审核已通过。

### Q2: 提示"民宿名称已被注册"？
**A**: 每个民宿名称必须唯一，请更换名称。

### Q3: 后端接口404？
**A**: 检查后端是否正常启动，Controller是否被正确扫描。

### Q4: 前端页面空白？
**A**: 检查浏览器控制台错误信息，可能是API调用失败。

### Q5: 数据库迁移失败？
**A**: 检查Flyway版本号是否正确，确保版本号递增。

---

## 📞 技术支持

如有问题，请联系开发团队或查看系统日志：
- 后端日志: `logs/yxly-backend.log`
- 前端控制台: 浏览器开发者工具

---

**祝您使用愉快！** 🎉
